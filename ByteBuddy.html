<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ByteBuddy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=OpenDyslexic&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: #333;
            position: relative;
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        body.simplify-mode {
            font-family: 'OpenDyslexic', 'Roboto', sans-serif;
        }

        body.light-mode {
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            color: #333;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            color: #ecf0f1;
        }

        /* Home Page Styling */
        #home-page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            z-index: 1001;
        }

        #home-page.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .home-content {
            text-align: center;
            color: #333;
            max-width: 600px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .home-content h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .home-content p {
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        #home-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        #home-message-input-container {
            display: flex;
            width: 100%;
            max-width: 500px;
        }

        #home-message-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 25px 0 0 25px;
            outline: none;
            font-size: 16px;
            resize: none;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.3);
            color: #333;
            transition: background-color 0.3s ease;
            spellcheck: true;
        }

        #home-message-input:focus {
            background-color: rgba(255, 255, 255, 0.4);
        }

        #home-message-button {
            background-color: rgba(76, 161, 175, 0.6);
            color: white;
            border: none;
            margin-left: 0;
            padding: 15px;
            border-radius: 0 25px 25px 0;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #home-message-button:hover {
            background-color: rgba(60, 162, 175, 0.9);
            transform: translateY(-2px);
        }

        #main-container {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: row;
        }

        #history-pane {
            width: 25%;
            min-width: 200px;
            max-width: 300px;
            background: linear-gradient(160deg, rgba(44, 62, 80, 0.7), rgba(76, 161, 175, 0.7));
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            border-top-left-radius: 20px;
            border-bottom-left-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-right: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: 3px 0 5px rgba(0,0,0,0.1);
        }

        #history-pane h3 {
            margin-bottom: 10px;
            color: #fff;
            text-align: center;
            font-size: 1.2em;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .history-message {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 10px;
            color: #fff;
            word-wrap: break-word;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .history-message:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        #chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: transparent;
            padding: 20px;
            position: relative;
        }

        /* Header Styling */
        #header {
            padding: 20px;
            text-align: center;
            font-size: 1.8em;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            color: #fff;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        /* Chatbox Styling */
        #chatbox {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            font-size: 16px;
            line-height: 1.5;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 10px;
        }

        /* Message Styling */
        .message {
            margin: 10px 0;
            padding: 15px 20px;
            border-radius: 25px;
            max-width: 80%;
            position: relative;
            animation: fadeIn 0.3s ease;
            box-shadow: none;
            word-wrap: break-word;
        }

        .user-message {
            background-color: rgba(97, 218, 251, 0.6);
            align-self: flex-end;
            color: #333;
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            background-color: rgba(76, 161, 175, 0.6);
            align-self: flex-start;
            color: #fff;
            border-bottom-left-radius: 5px;
            position: relative;
        }

        /* Loader Animation */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        .typing-indicator {
            font-style: italic;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Options Container Styling */
        #options-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            flex-wrap: wrap;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            margin-bottom: 10px;
        }

        .option {
            background-color: rgba(76, 161, 175, 0.6);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: none;
        }

        .option:hover {
            background-color: rgba(60, 162, 175, 0.9);
            transform: translateY(-2px);
        }

        .option.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Message Input Container Styling */
        #message-input-container {
            display: flex;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            width: 100%;
            max-width: 600px;
            align-self: center;
        }

        #message-input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            resize: none;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.3);
            color: #333;
            transition: background-color 0.3s ease;
            spellcheck: true;
        }

        #message-input:focus {
            background-color: rgba(255, 255, 255, 0.4);
        }

        #message-button {
            background-color: rgba(76, 161, 175, 0.6);
            color: white;
            border: none;
            margin-left: 15px;
            padding: 15px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #message-button:hover {
            background-color: rgba(60, 162, 175, 0.9);
            transform: translateY(-2px);
        }

        /* Button Container Styling */
        #button-container {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            flex-wrap: wrap;
            gap: 15px;
            position: relative;
        }

        /* Email Container Styling */
        #email-container {
            display: none;
            flex-direction: column;
            align-items: center;
            background-color: rgba(44, 62, 80, 0.95);
            padding: 30px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            border-radius: 20px;
            z-index: 1002;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            animation: fadeIn 0.5s ease;
        }

        #email-container.active {
            display: flex;
        }

        #close-email-btn {
            position: absolute;
            top: 15px;
            right: 25px;
            cursor: pointer;
            color: #fff;
            font-size: 25px;
        }

        /* Sign-in Modal Styling */
        #signin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #signin-modal.active {
            visibility: visible;
            opacity: 1;
        }

        #signin-form {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        #signin-form h2 {
            margin-bottom: 20px;
            color: #333;
        }

        #signin-form input {
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 16px;
        }

        #signin-form button {
            width: 100%;
            padding: 12px;
            background-color: rgba(76, 161, 175, 0.6);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #signin-form button:hover {
            background-color: rgba(60, 162, 175, 0.9);
            transform: translateY(-2px);
        }

        /* Code Block Styling */
        pre {
            background: #f5f2f0 !important;
            padding: 10px !important;
            border-radius: 5px !important;
            overflow: auto !important;
        }

        code {
            font-family: 'Courier New', Courier, monospace;
        }

        /* Quiz Styling */
        .quiz-question {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quiz-option {
            padding: 10px;
            border: none;
            border-radius: 10px;
            background-color: rgba(76, 161, 175, 0.6);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .quiz-option:hover {
            background-color: rgba(60, 162, 175, 0.9);
            transform: translateY(-2px);
        }

        /* Aggregated Answer Styling */
        .aggregated-answer {
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 15px;
            color: #fff;
        }

        .aggregated-answer h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
        }

        .aggregated-answer p {
            margin-bottom: 10px;
        }

        .aggregated-answer a {
            color: #1a73e8;
            text-decoration: none;
            font-weight: bold;
        }

        .aggregated-answer a:hover {
            text-decoration: underline;
        }

        /* Image Message Styling */
        .image-message img {
            border: none;
            box-shadow: none;
            border-radius: 10px;
            margin-top: 10px;
            max-width: 100%;
            height: auto;
            transition: transform 0.3s ease;
        }

        .image-message img:hover {
            transform: scale(1.02);
        }


        .rewrite-button {
            margin-top: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .rewrite-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px);
        }

        .rewritten-message {
            background-color: rgba(240, 128, 128, 0.6);
            color: #fff;
            border-bottom-left-radius: 5px;
            margin-top: 5px;
        }

        .small-button {
            width: 40px;
            height: 40px;
            padding: 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: rgba(76, 161, 175, 0.6);
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: none;
        }

        .small-button:hover {
            background-color: rgba(60, 162, 175, 0.9);
            transform: translateY(-2px);
        }

        .small-button.active {
            background-color: rgba(255, 0, 0, 0.6); 
        }

        .small-button .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 15px;
            height: 15px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 10px;
            right: 10px;
        }


        body.voice-call-active {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            transition: background 0.5s ease;
        }


        body.voice-call-active::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
            animation: rotateBackground 20s linear infinite;
            z-index: 0;
        }

        @keyframes rotateBackground {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dark-mode #header {
            background-color: rgba(44, 62, 80, 0.6);
            color: #ecf0f1;
        }

        .dark-mode .user-message {
            background-color: rgba(41, 128, 185, 0.6);
            color: #ecf0f1;
        }

        .dark-mode .bot-message {
            background-color: rgba(44, 62, 80, 0.6);
            color: #ecf0f1;
        }

        .dark-mode .option {
            background-color: rgba(44, 62, 80, 0.6);
        }

        .dark-mode .option:hover {
            background-color: rgba(28, 89, 128, 0.9);
            transform: translateY(-2px);
        }

        .dark-mode #message-input {
            background-color: rgba(236, 240, 241, 0.2);
            color: #ecf0f1;
            border-color: #2980b9;
        }

        .dark-mode #message-input:focus {
            background-color: rgba(236, 240, 241, 0.3);
            border-color: #1c5980;
        }

        .dark-mode #message-button {
            background-color: rgba(44, 62, 80, 0.6);
        }

        .dark-mode #message-button:hover {
            background-color: rgba(28, 89, 128, 0.9);
            transform: translateY(-2px);
        }

        .dark-mode #button-container button {
            background-color: rgba(44, 62, 80, 0.6);
        }

        .dark-mode #button-container button:hover {
            background-color: rgba(28, 89, 128, 0.9);
            transform: translateY(-2px);
        }

        .dark-mode #history-pane {
            background-color: rgba(44, 62, 80, 0.6);
            color: #ecf0f1;
        }

        .dark-mode .history-message {
            background-color: rgba(41, 128, 185, 0.6);
            color: #ecf0f1;
        }

        .dark-mode #email-container {
            background-color: rgba(44, 62, 80, 0.95);
        }

        .dark-mode #email-form button {
            background-color: #27ae60;
        }

        .dark-mode #email-form button:hover {
            background-color: #1e8449;
            transform: translateY(-2px);
        }

        /* Simple Mode Adjustments */
        body.simple-mode {
            font-size: 1.1em;
        }

        body.simple-mode #chatbox {
            font-family: 'Arial', sans-serif;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            #history-pane {
                display: none;
            }

            #chat-container {
                width: 100%;
            }

            #message-input-container {
                width: 95%;
            }
        }

        @media (max-width: 768px) {
            #chat-container {
                padding: 10px;
            }

            #header {
                font-size: 1.5em;
            }

            .message {
                max-width: 90%;
            }

            .option {
                width: 45%;
                font-size: 14px;
            }

            #message-input {
                font-size: 16px;
                height: 60px;
            }

            #message-button {
                padding: 15px;
                font-size: 20px;
            }

            #button-container button, #more-options-dropdown button {
                font-size: 14px;
                padding: 10px 18px;
            }

            #open-sidebar-btn {
                bottom: 20px;
                right: 20px;
                padding: 15px;
                font-size: 20px;
            }

            #signin-form {
                padding: 20px;
            }

            #signin-form h2 {
                font-size: 1.5em;
            }
        }

    </style>
     <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@1.0.0/dist/transformers.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
     <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
     <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-lua.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
     <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
     <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
     <script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script>
 </head>
 <body>
 
     <div id="home-page" class="active">
         <div class="home-content">
             <h1>Welcome to ByteBuddy! 👋</h1>
             <p>Your friendly chatbot assistant is here to help you.</p>
             <div id="home-options" class="options-container">
                 <div class="option" onclick="presetOption('What is photosynthesis?')">🌱 What is photosynthesis?</div>
                 <div class="option" onclick="presetOption('Tell me a joke')">😂 Tell me a joke</div>
                 <div class="option" onclick="presetOption('Tell me a riddle')">❓ Tell me a riddle</div>
                 <div class="option" onclick="triggerImageUpload()" id="upload-image-button">📷 Upload Image</div>
                 <div class="option" onclick="startQuiz()">📚 Start Quiz</div>
                 <div class="option small-button" onclick="toggleVoiceCall()" id="voice-call-button">📞</div>
             </div>
             <div id="home-message-input-container">
                 <textarea id="home-message-input" placeholder="Type your message..." rows="1" spellcheck="true"></textarea>
                 <button type="button" id="home-message-button" onclick="startChat()">➤</button>
             </div>
         </div>
     </div>
 
     <div id="signin-modal">
         <form id="signin-form">
             <h2>Welcome!</h2>
             <input type="text" id="user-name-input" placeholder="Enter your name" required>
             <button type="submit">Sign In</button>
         </form>
     </div>
 
     <div id="main-container">

         <div id="history-pane">
             <h3>📜 History</h3>
             <div id="history-content">

             </div>
         </div>
 
         <div id="chat-container">
             <!-- Header -->
             <div id="header">
                 Hello, <span id="user-name">User</span>! 😊
                 <button id="change-name-button" onclick="openChangeNameModal()" style="background:none; border:none; color: #fff; cursor:pointer; font-size:1em;">
                     ✏️
                 </button>
             </div>

             <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">

                <button id="toggle-button" style="padding: 10px; border-radius: 50%; background-color: #89B7CC; color: white; border: none; font-size: 18px; cursor: pointer;">☰</button>
            
    
                <div id="button-group" style="display: none; margin-top: 10px; text-align: center;">
                    <button class="style-button" data-style="Conversational" style="padding: 10px; margin: 5px; border-radius: 5px; background-color: #89B7CC; color: white; border: none; cursor: pointer;">Conversational</button>
                    <button class="style-button" data-style="Formal" style="padding: 10px; margin: 5px; border-radius: 5px; background-color: #89B7CC; color: white; border: none; cursor: pointer;">Formal</button>
                    <button class="style-button" data-style="Humorous" style="padding: 10px; margin: 5px; border-radius: 5px; background-color: #89B7CC; color: white; border: none; cursor: pointer;">Humorous</button>
                    <button class="style-button" data-style="Informative" style="padding: 10px; margin: 5px; border-radius: 5px; background-color: #89B7CC; color: white; border: none; cursor: pointer;">Informative</button>
                </div>
            </div>
            

             <button id="upload-doc-button" class="option" onclick="triggerDocUpload()">📁 Upload Document</button>
            <input 
            type="file" 
            id="doc-input" 
            accept=".doc,.docx,.xls,.xlsx,.ppt,.pptx" 
            style="display: none;" 
            onchange="handleDocUpload(event)" 
            />
 
             <div id="chatbox"></div>
 
             <div id="options-container">
                 <div class="option" onclick="presetOption('What is photosynthesis?')">🌱 What is photosynthesis?</div>
                 <div class="option" onclick="presetOption('Tell me a joke')">😂 Tell me a joke</div>
                 <div class="option" onclick="presetOption('Tell me a riddle')">❓ Tell me a riddle</div>
                 <div class="option" onclick="triggerImageUpload()" id="upload-image-button">📷 Upload Image</div>
                 <div class="option" onclick="startQuiz()">📚 Start Quiz</div>
                 <div class="option small-button" onclick="toggleVoiceCall()" id="voice-call-button">📞</div>
                 <div class="option" onclick="startScreenShare()">🖥️ Share Screen</div>

             </div>
 
             <div id="message-input-container">
                 <textarea id="message-input" placeholder="Type your message..." rows="1" spellcheck="true"></textarea>
                 <button type="button" id="message-button" onclick="sendMessage()">➤</button>
             </div>
 
             <div id="button-container">
                 <!-- Additional buttons can be added here -->
             </div>
         </div>
     </div>
 
     <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
 
     <div id="email-container">
         <h2>Compose Email</h2>
         <span id="close-email-btn" onclick="closeEmailForm()">×</span>
         <form id="email-form" onsubmit="sendEmail(event)">
             <input type="email" id="email-recipient" placeholder="Recipient" required>
             <input type="text" id="email-subject" placeholder="Subject" required>
             <textarea id="email-message" placeholder="Message" rows="5" required></textarea>
             <button type="submit">Send Email</button>
         </form>
     </div>
 
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 
     <script>
    let mobilenetModel;
    let modelLoaded = false;


    window.addEventListener('DOMContentLoaded', () => {
        loadModel();
    });


    async function loadModel() {
        try {
            displayMessage("🔄 Loading image recognition model...", "bot-message");
            mobilenetModel = await mobilenet.load();
            modelLoaded = true;
            displayMessage("✅ Image recognition model loaded!", "bot-message");
        } catch (err) {
            console.error("Model load error:", err);
            displayMessage("❌ Failed to load MobileNet model.", "bot-message");
        }
    }

    async function startScreenShare() {
    try {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
    } catch (err) {
        console.error("Screen share error:", err);
        
        if (err.name === "NotAllowedError") {
            displayMessage("❌ You denied the screen share prompt.", "bot-message");
        } else if (err.name === "NotFoundError") {
            displayMessage("❌ No screen display found or no screen was selected.", "bot-message");
        } else {
            displayMessage("❌ Screen share canceled or failed.", "bot-message");
        }
    }
}


    async function startScreenShare() {
        try {
   
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            displayMessage("✅ Screen sharing started. Capturing a frame...", "bot-message");

    
            const video = document.createElement('video');
            video.srcObject = screenStream;
            video.autoplay = true;

            await new Promise((resolve) => {
                video.onplaying = resolve;
            });

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            screenStream.getTracks().forEach(track => track.stop());

            const imageSrc = canvas.toDataURL('image/png');

            displayMessage(`<img src="${imageSrc}" alt="Screen Capture" style="max-width:100%;"/>`, "user-message");

            let objects = [];
            if (!modelLoaded) {
                displayMessage("⚠️ MobileNet not yet loaded. Loading now...", "bot-message");
                await loadModel();
            }
            objects = await analyzeScreenImage(imageSrc);

     
            const text = await performScreenOCR(imageSrc);

            const summary = generateScreenSummary(objects, text);
            displayMessage(`📊 **Screen Summary (150 words)**:\n\n${summary}`, "bot-message");

        } catch (err) {
            console.error("Screen share error:", err);
            displayMessage("❌ Screen share canceled or failed.", "bot-message");
        }
    }

    async function analyzeScreenImage(imageSrc) {
        const img = new Image();
        img.src = imageSrc;
        img.crossOrigin = "anonymous";
        await img.decode();

        const predictions = await mobilenetModel.classify(img);
        if (predictions.length > 0) {
            const objectList = predictions.map(
                p => `${p.className} (${(p.probability*100).toFixed(2)}%)`
            );
            displayMessage(`📋 Objects Detected: ${objectList.join(", ")}`, "bot-message");
            return objectList;
        } else {
            displayMessage("❓ No objects detected.", "bot-message");
            return [];
        }
    }

    async function performScreenOCR(imageSrc) {
        displayMessage("🔍 Performing OCR on captured screen...", "bot-message");
        try {
            const { data: { text } } = await Tesseract.recognize(imageSrc, 'eng');
            const trimmed = text.trim();
            if (trimmed) {
                displayMessage(`📝 Detected Text: ${trimmed}`, "bot-message");
            } else {
                displayMessage("No visible text found.", "bot-message");
            }
            return trimmed;
        } catch (error) {
            console.error("OCR error:", error);
            displayMessage("❌ OCR failed on screen capture.", "bot-message");
            return "";
        }
    }

    function generateScreenSummary(objects, text) {
        const objDescription = objects.length 
            ? `Visually, the screen shows elements like: ${objects.join(", ")}. ` 
            : "";
        const txtDescription = text 
            ? `Textually, some words or sentences appear, including: "${text}". `
            : "";

        let baseSummary = `
These combined observations from both text and objects help ByteBuddy understand the user's current activity and on-screen context. 
By recognizing certain objects (windows, icons, or other visual elements) and reading any textual content, ByteBuddy can provide more precise assistance and suggestions. 
The snapshot indicates the user might be referencing or browsing specific materials, possibly for research, entertainment, or project-related tasks. 
Overall, merging OCR and object detection facilitates a holistic view of the screen, allowing ByteBuddy to respond with relevant information, instructions, or clarifications.
`.trim();

       
        let combined = objDescription + txtDescription + baseSummary;

   
        combined = limitToWords(combined, 150);
        return combined;
    }

    function limitToWords(text, maxWords) {
        const words = text.split(/\s+/);
        if (words.length <= maxWords) return text;
        return words.slice(0, maxWords).join(" ") + "...";
    }


    function displayMessage(text, className) {
        const chatbox = document.getElementById("chatbox");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${className}`;
        messageDiv.innerHTML = text;
        chatbox.appendChild(messageDiv);
        chatbox.scrollTop = chatbox.scrollHeight;
    }


window.addEventListener('DOMContentLoaded', async () => {
    try {
        document.getElementById("output").innerText = "Loading models...";
        mobilenetModel = await mobilenet.load();
        console.log("Mobilenet loaded successfully!");
        document.getElementById("output").innerText = "Models loaded. Upload an image!";
    } catch (err) {
        console.error("Error loading Mobilenet:", err);
        document.getElementById("output").innerText = "Failed to load models.";
    }
});


async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) {
        displayMessage("No file uploaded.", "error");
        return;
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
        const imageSrc = e.target.result;
        displayMessage(`<img src="${imageSrc}" alt="Uploaded Image" style="max-width:100%;"/>`, "image");
        analyzeImage(imageSrc); // Perform Mobilenet analysis
        performOCR(imageSrc); // Perform OCR analysis
    };

    reader.onerror = () => {
        displayMessage("Error reading the file.", "error");
    };

    reader.readAsDataURL(file);
}

// Display messages or images in the output div
function displayMessage(message, type = "text") {
    const output = document.getElementById("output");
    if (type === "image") {
        output.innerHTML = message;
    } else {
        const messageDiv = document.createElement("div");
        messageDiv.textContent = message;
        output.appendChild(messageDiv);
    }
}

// Analyze image with Mobilenet
async function analyzeImage(imageSrc) {
    try {
        const img = new Image();
        img.src = imageSrc;
        img.crossOrigin = "anonymous";
        img.onload = async () => {
            const predictions = await mobilenetModel.classify(img);
            if (predictions.length > 0) {
                const objects = predictions.map(p => `${p.className} (${(p.probability * 100).toFixed(2)}%)`);
                displayMessage(`Detected Objects: ${objects.join(", ")}`);
                generateDescription(objects, null);
            } else {
                displayMessage("No objects detected.");
            }
        };
    } catch (error) {
        console.error("Error during image analysis:", error);
        displayMessage("Error analyzing the image.");
    }
}

async function performOCR(imageSrc) {
    try {
        displayMessage("Performing OCR...");
        const { data: { text } } = await Tesseract.recognize(imageSrc, 'eng');
        if (text.trim()) {
            displayMessage(`Detected Text: ${text}`);
            generateDescription(null, text);
        } else {
            displayMessage("No text detected in the image.");
        }
    } catch (error) {
        console.error("Error during OCR:", error);
        displayMessage("Error performing OCR.");
    }
}

// Generate a 200-word description
function generateDescription(objects, text) {
    let description = "📝 Here's a description of the image:\n\n";
    if (objects) {
        description += `The image contains: ${objects.join(", ")}. `;
    }
    if (text) {
        description += `It includes the text: "${text}". `;
    }
    description += "This combination provides a unique visual narrative and highlights the elements present in the scene.";
    displayMessage(description);
}

const toggleButton = document.getElementById("toggle-button");
const buttonGroup = document.getElementById("button-group");


toggleButton.addEventListener("click", () => {
    if (buttonGroup.style.display === "none") {
        buttonGroup.style.display = "block";
    } else {
        buttonGroup.style.display = "none";
    }
});


document.querySelectorAll(".style-button").forEach(button => {
    button.addEventListener("click", (event) => {

        document.querySelectorAll(".style-button").forEach(btn => {
            btn.innerHTML = btn.innerHTML.replace(" ✅", "");
        });


        const clickedButton = event.target;
        clickedButton.innerHTML += " ✅";
    });
});


function triggerDocUpload() {
  const docInput = document.getElementById('doc-input');
  docInput.value = ""; 
  docInput.click();
}


function handleDocUpload(event) {
  const file = event.target.files[0];
  if (!file) {
    displayMessage("❌ No file selected.", "bot-message");
    return;
  }

  const baseName = file.name.replace(/\.[^/.]+$/, "").toLowerCase();


  const snippet = generate150WordSnippet(baseName);

  displayMessage(snippet, "bot-message");
}

function generate150WordSnippet(docName) {

  return `
The uploaded file "${docName}" appears to be a valuable resource that may contain insights, data, or content worthy of exploration. By examining its topic closely, we can uncover key themes, historical context, or scientific foundations relevant to "${docName}". Approaching it methodically often reveals logical structures, best practices, or problem-solving approaches that benefit researchers, students, and professionals alike. Discussion around "${docName}" fosters collaboration and sparks curiosity, encouraging a variety of perspectives to emerge. This process can highlight gaps in our understanding, prompting further investigation or experimentation. Through open-minded engagement with "${docName}", we refine our critical-thinking skills and develop a richer appreciation of its complexities. Moreover, the outcomes of such inquiry can catalyze innovative solutions and actionable strategies in the real world. Ultimately, learning from "${docName}" nurtures intellectual growth and drives progress, empowering individuals to share discoveries and build on each other's contributions, elevating the broader community of learners.
  `.trim();
}


 

    async function generateSpeech() {
            const topic = document.getElementById("topic-input").value;
            if (!topic) {
                alert("Please enter a topic.");
                return;
            }

            const API_KEY = "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"; 
            const API_URL = "https://api.anthropic.com/v1/complete";

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${API_KEY}`,
                    },
                    body: JSON.stringify({
                        model: "claude-2", 
                        prompt: `\n\nHuman: Write a detailed and engaging speech about ${topic}.\n\nAssistant:`,
                        max_tokens_to_sample: 500, 
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                if (data.completion) {
                    const speech = data.completion.trim();
                    document.getElementById("output").innerHTML = `<h3>Generated Speech:</h3><p>${speech}</p>`;
                } else {
                    document.getElementById("output").innerHTML = "<p>No speech generated. Please try again.</p>";
                }
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("output").innerHTML = `<p>An error occurred: ${error.message}</p>`;
            }
        }


         let distilGPT2;
 
         async function loadDistilGPT2Model() {
             displayMessage("🔄 Loading DistilGPT-2 model...", "bot-message");
             try {
                 distilGPT2 = await window.transformers.pipeline('text-generation', 'Xenova/distilgpt2');
                 displayMessage("✅ DistilGPT-2 model loaded and ready!", "bot-message");
             } catch (error) {
                 displayMessage("❌ Failed to load DistilGPT-2 model.", "bot-message");
                 console.error("Model Loading Error:", error);
             }
         }
 
         window.addEventListener('DOMContentLoaded', () => {
             loadDistilGPT2Model();
             initializeChatbot();
             loadModel();
             loadVoices();
             initializeSignIn();
             loadHistory();
             applyDarkModeBasedOnTime();
         });
 
         class Chatbot {
             constructor() {
                 this.jokes = [
                     "Why don't scientists trust atoms? Because they make up everything! 😂",
                     "Why did the chicken join a band? Because it had the drumsticks! 🥁",
                     "I told my computer I needed a break, and it said 'No problem — I'll go to sleep.' 💤",
                     "Why was the math book sad? It had too many problems. 📚😢"
                 ];
                 this.riddles = [
                     "What has keys but can't open locks? A piano!",
                     "What gets wetter the more it dries? A towel!",
                     "I speak without a mouth and hear without ears. What am I? An echo.",
                     "What can travel around the world while staying in a corner? A stamp."
                 ];
                 this.stories = [
                     "Once upon a time in a land far away, there lived a kind and courageous knight. One day, he embarked on a great adventure to save the kingdom...",
                     "In a magical forest, there was a little girl named Lily who found an enchanted flower. As soon as she touched it, a secret door appeared leading to a hidden world...",
                     "There was once a young inventor who dreamed of creating a flying machine. After years of effort and failures, one day, his invention finally took flight, and he soared through the sky...",
                     "Deep in the ocean, a curious dolphin named Delilah discovered a mysterious cave filled with sparkling treasures and ancient secrets..."
                 ];
                 this.translations = {
                     spanish: "Traducción en español: ",
                     french: "Traduction en français: ",
                     german: "Übersetzung auf Deutsch: ",
                     italian: "Traduzione in italiano: ",
                     dutch: "Vertaling in het Nederlands: ",
                     portuguese: "Tradução em português: "
                 };
 
                 this.misspellings = {
                     photosythsisee: "photosynthesis",
                     fotossinthsis: "photosynthesis",
                     "accomadate": "accommodate",
                     "recieve": "receive",
                     "adress": "address",
                     "seperate": "separate"
                 };
 
                 this.codeTemplates = {
                     python: {
                         chatbot: `
 def chatbot():
     print("Hello! I'm ByteBuddy, your assistant.")
     while True:
         user_input = input("You: ")
         if user_input.lower() in ['exit', 'quit', 'bye']:
             print("ByteBuddy: Goodbye! Have a great day!")
             break
         else:
             print(f"ByteBuddy: You said '{user_input}'. How can I assist you further?")
 
 if __name__ == "__main__":
     chatbot()
                         `,
                         web_server: `
 from flask import Flask, request
 
 app = Flask(__name__)
 
 @app.route('/')
 def home():
     return "Hello, I'm ByteBuddy's web server!"
 
 @app.route('/echo', methods=['POST'])
 def echo():
     data = request.get_json()
     return {"you_sent": data}, 200
 
 if __name__ == "__main__":
     app.run(debug=True)
                         `
                     },
                     lua: {
                         chatbot: `
 function chatbot()
     print("Hello! I'm ByteBuddy, your assistant.")
     while true do
         io.write("You: ")
         local user_input = io.read()
         if user_input:lower() == "bye" or user_input:lower() == "quit" or user_input:lower() == "exit" then
             print("ByteBuddy: Goodbye! Have a great day!")
             break
         else
             print("ByteBuddy: You said '" .. user_input .. "'. How can I assist you further?")
         end
     end
 end
 
 chatbot()
                         `
                     },
                     java: {
                         chatbot: `
 import java.util.Scanner;
 
 public class ByteBuddyChatbot {
     public static void main(String[] args) {
         Scanner scanner = new Scanner(System.in);
         System.out.println("Hello! I'm ByteBuddy, your assistant.");
         while (true) {
             System.out.print("You: ");
             String userInput = scanner.nextLine();
             if (userInput.equalsIgnoreCase("bye") || userInput.equalsIgnoreCase("quit") || userInput.equalsIgnoreCase("exit")) {
                 System.out.println("ByteBuddy: Goodbye! Have a great day!");
                 break;
             } else {
                 System.out.println("ByteBuddy: You said '" + userInput + "'. How can I assist you further?");
             }
         }
         scanner.close();
     }
 }
                         `
                     },
                     javascript: {
                         chatbot: `
 const readline = require('readline');
 
 const rl = readline.createInterface({
     input: process.stdin,
     output: process.stdout
 });
 
 console.log("Hello! I'm ByteBuddy, your assistant.");
 
 function chatbot() {
     rl.question("You: ", (userInput) => {
         if (userInput.toLowerCase() === 'bye' || userInput.toLowerCase() === 'quit' || userInput.toLowerCase() === 'exit') {
             console.log("ByteBuddy: Goodbye! Have a great day!");
             rl.close();
         } else {
             console.log(\`ByteBuddy: You said '\${userInput}'. How can I assist you further?\`);
             chatbot();
         }
     });
 }
 
 chatbot();
                         `
                     },
                     cpp: {
                         chatbot: `
 #include <iostream>
 #include <string>
 
 int main() {
     std::string userInput;
     std::cout << "Hello! I'm ByteBuddy, your assistant." << std::endl;
     while (true) {
         std::cout << "You: ";
         std::getline(std::cin, userInput);
         if (userInput == "bye" || userInput == "quit" || userInput == "exit") {
             std::cout << "ByteBuddy: Goodbye! Have a great day!" << std::endl;
             break;
         } else {
             std::cout << "ByteBuddy: You said '" << userInput << "'. How can I assist you further?" << std::endl;
         }
     }
     return 0;
 }
                         `
                     }
                 };
 
                 this.languageCodes = {
                     'arabic': 'ar',
                     'chinese': 'zh',
                     'dutch': 'nl',
                     'english': 'en',
                     'french': 'fr',
                     'german': 'de',
                     'hindi': 'hi',
                     'italian': 'it',
                     'japanese': 'ja',
                     'korean': 'ko',
                     'portuguese': 'pt',
                     'russian': 'ru',
                     'spanish': 'es',
                 };
 
                 this.mnemonics = {
                     "multiplication": "Multiplication is like adding groups of the same number.",
                     "division": "Division is splitting a number into equal parts."
                 };
 
                 this.gpt2Model = null;
                 this.gpt2Loaded = false;
 
                 this.lastAnswer = "";
             }
 
             async loadGPT2Model() {
                 displayMessage("🔄 Loading ByteBuddy Gen 2 model...", "bot-message");
                 try {
                     this.gpt2Model = await tf.loadGraphModel('https://your-server.com/path/to/gpt2/model.json');
                     this.gpt2Loaded = true;
                     displayMessage("✅ ByteBuddy Gen 2 is ready to use!", "bot-message");
                 } catch (error) {
                     displayMessage("❌ Failed to load ByteBuddy Gen 2 model.", "bot-message");
                     console.error("GPT-2 Load Error:", error);
                 }
             }
             

             getHardcodedVideoURL(query) {
    const videoMap = {
        "cats": "https://www.youtube.com/embed/tntOCGkgt98",
        "dogs": "https://www.youtube.com/embed/YrLk4sd3tx0", 
        "photosynthesis": "https://www.youtube.com/embed/1lTnB9frJFE", 
        "guitar lessons": "https://www.youtube.com/embed/Bb5av0ZIrkc", 
        "piano tutorial": "https://www.youtube.com/embed/Z1Xun8SGaGA", 
        "quantum mechanics basics": "https://www.youtube.com/embed/GDgNhX1cY2E", 
        "history of rome": "https://www.youtube.com/embed/fRV5SWJ6X_I", 
        "french language basics": "https://www.youtube.com/embed/HwMS02pOHE0", 
        "javascript tutorial": "https://www.youtube.com/embed/W6NZfCO5SIk", 
        "python tutorial": "https://www.youtube.com/embed/_uQrJ0TkZlc",
        "machine learning intro": "https://www.youtube.com/embed/ukzFI9rgwfU", 
        "cooking pasta": "https://www.youtube.com/embed/9u0vQZTz6Nw",
        "cooking curry": "https://www.youtube.com/embed/8jT9QJ2DhOY",
        "baking bread": "https://www.youtube.com/embed/1-LF8NRkYkM", 
        "yoga for beginners": "https://www.youtube.com/embed/v7AYKMP6rOE", 
        "meditation guide": "https://www.youtube.com/embed/InN8seMm7UI", 
        "intro to algebra": "https://www.youtube.com/embed/2GK2NlpniZs", 
        "calculus basics": "https://www.youtube.com/embed/8mAITcNt710", 
        "physics 101": "https://www.youtube.com/embed/IEe-UG0XAdI",
        "chemistry experiments": "https://www.youtube.com/embed/RuNrS4Ux__E", 
        "biology cells": "https://www.youtube.com/embed/d5a7bGiT9Jk", 
        "astronomy stars": "https://www.youtube.com/embed/PuI0ht6tZJk", 
        "geography of europe": "https://www.youtube.com/embed/RO96sS2VqCU",
        "spanish lessons": "https://www.youtube.com/embed/lSJrP7McyXM", 
        "german language basics": "https://www.youtube.com/embed/5X3Cq7sEMJk", 
        "home workout": "https://www.youtube.com/embed/vpUO2e0a2mI",
        "cardio exercises": "https://www.youtube.com/embed/ML6cT4AZdqI",
        "strength training": "https://www.youtube.com/embed/gC7HZWnRRW8", 
        "gardening tips": "https://www.youtube.com/embed/8KtVMlZrNFE", 
        "diy home improvement": "https://www.youtube.com/embed/0X7P6-7JYyo",
        "car maintenance": "https://www.youtube.com/embed/sY0zR07hn9g", 
        "budget travel": "https://www.youtube.com/embed/6ZNPxqILxFg",
        "digital painting": "https://www.youtube.com/embed/_hgFRj1S4zA", 
        "watercolor techniques": "https://www.youtube.com/embed/UcFq3LQ3J1g", 
        "oil painting lesson": "https://www.youtube.com/embed/UcFq3LQ3J1g", 
        "learn knitting": "https://www.youtube.com/embed/GcNpm68WDRc", 
        "basic sewing": "https://www.youtube.com/embed/OXkCgY_jGXc",
        "history of jazz": "https://www.youtube.com/embed/nM-Ycpv6x0M",
        "classical music analysis": "https://www.youtube.com/embed/KjZfXhP-r94", 
        "rock guitar riffs": "https://www.youtube.com/embed/Z9xh4t3RtDw",
        "hip hop dance moves": "https://www.youtube.com/embed/f00n0oOz3eI", 
        "ballet basics": "https://www.youtube.com/embed/eNJ5t1J2X0k", 
        "movie reviews": "https://www.youtube.com/embed/eK52Pf0KAnQ",
        "filmmaking tips": "https://www.youtube.com/embed/xbFc2TzLwb0", 
        "photography lighting": "https://www.youtube.com/embed/q7V9ABVgkxs", 
        "portrait photography": "https://www.youtube.com/embed/IH1xtmVp3tA",
        "landscape photography": "https://www.youtube.com/embed/7qwzI9xPA9M",
        "video editing tutorial": "https://www.youtube.com/embed/r6jKzGJ4a2g", 
        "3d animation basics": "https://www.youtube.com/embed/v4u8lgIMaVc",
        "web development intro": "https://www.youtube.com/embed/3JluqTojuME", 
        "html and css": "https://www.youtube.com/embed/UB1O30fR-EE",
        "react.js tutorial": "https://www.youtube.com/embed/DLX62G4lc44", 
        "node.js tutorial": "https://www.youtube.com/embed/TlB_eWDSMt4", 
        "android app dev": "https://www.youtube.com/embed/fis26HvvDII", 
        "ios app dev": "https://www.youtube.com/embed/0fKg7e37bQE",
        "game development unity": "https://www.youtube.com/embed/IlKaB1etrik", 
        "game development unreal": "https://www.youtube.com/embed/8Y3g3aMZUTk", 
        "financial advice": "https://www.youtube.com/embed/4qfVJzqC2t0", 
        "stock market basics": "https://www.youtube.com/embed/8rX2CSp2J8Y", 
        "cryptocurrency explainers": "https://www.youtube.com/embed/6GuH5-SY8mY",
        "interior design tips": "https://www.youtube.com/embed/v1U4IG3PfF0", 
        "minimalist lifestyle": "https://www.youtube.com/embed/OHJeIw2hkg0", 
        "vegan recipes": "https://www.youtube.com/embed/4aQz20nlfBg", 
        "keto diet": "https://www.youtube.com/embed/fW7F7yjW1jA", 
        "asian cuisine": "https://www.youtube.com/embed/3ZwXk0u0uWU", 
        "french cooking": "https://www.youtube.com/embed/S0hF-LiG8Uk",
        "italian cooking": "https://www.youtube.com/embed/Z4nA9KtcwU0", 
        "baking cakes": "https://www.youtube.com/embed/M5tqVc9NuxA", 
        "pastry making": "https://www.youtube.com/embed/E8jnsFZKmOg", 
        "coffee brewing": "https://www.youtube.com/embed/1kH8XTfjNto", 
        "tea ceremony": "https://www.youtube.com/embed/JvG3nE60Hx8", 
        "bonsai care": "https://www.youtube.com/embed/8zncTiux2WA", 
        "succulent care": "https://www.youtube.com/embed/KWbVqG_Jh7k", 
        "houseplant tips": "https://www.youtube.com/embed/t1Xk7-2V_tk", 
        "hiking gear": "https://www.youtube.com/embed/3bCkFbWX2gE",
        "camping hacks": "https://www.youtube.com/embed/5wz0nBVzpl4", 
        "travel vlogs": "https://www.youtube.com/embed/5clyCxa9j7g", 
        "coding interview prep": "https://www.youtube.com/embed/R1riw8kAtNk", 
        "resume writing": "https://www.youtube.com/embed/3vqwDORs2Po",
        "job interview tips": "https://www.youtube.com/embed/HT0rZCeDmjU",
        "public speaking": "https://www.youtube.com/embed/VNawR6D3bKY", 
        "leadership skills": "https://www.youtube.com/embed/ROxjbAMr1EI",
        "time management": "https://www.youtube.com/embed/Y4PcltfzB6s", 
        "productivity hacks": "https://www.youtube.com/embed/7TUTaeuRsfk", 
        "mindfulness practice": "https://www.youtube.com/embed/-1ZgwOGkQSc",
        "stress reduction": "https://www.youtube.com/embed/Yk-AgjLFlFs", 
        "budgeting 101": "https://www.youtube.com/embed/F9DN9hG8joU",
        "saving money tips": "https://www.youtube.com/embed/7W1s5XhN6tI",
        "debt management": "https://www.youtube.com/embed/E3IhKy7b9Po", 
        "credit score improve": "https://www.youtube.com/embed/KYbPksdqlFM", 
        "retirement planning": "https://www.youtube.com/embed/N0Yk_CjzLZk", 
        "first aid tutorial": "https://www.youtube.com/embed/ntK5pGDm1Z0", 
        "cpr training": "https://www.youtube.com/embed/X5g0-S4HlFY", 
        "road safety tips": "https://www.youtube.com/embed/LKZlLdxzOqI", 
        "car driving lessons": "https://www.youtube.com/embed/MYQ7q9cMqwY", 
        "bicycle maintenance": "https://www.youtube.com/embed/VXN_1Phc8qk", 
        "motorcycle tips": "https://www.youtube.com/embed/Zh1_7ITNQ6g",
        "sustainable living": "https://www.youtube.com/embed/BqE9f6LbD3w", 
        "zero waste living": "https://www.youtube.com/embed/0k1_6k0U5Jo", 
        "recycling guide": "https://www.youtube.com/embed/RnPzVtQSGnY", 
        "climate change basics": "https://www.youtube.com/embed/Pj5X0jRfbxc", 
        "green energy": "https://www.youtube.com/embed/VNq1uTlDd9Y",
        "wildlife documentary": "https://www.youtube.com/embed/6lg7T5MljQ0"  
    };

    for (const topic in videoMap) {
        if (query.includes(topic)) {
            return videoMap[topic];
        }
    }

    return null;
}

             setModel(model) {
                 this.selectedModel = model;
                 if (model === 'gpt2' && !this.gpt2Loaded) {
                     this.loadGPT2Model();
                 }
             }
 
             async generateDistilGPT2Response(prompt) {
                 if (!distilGPT2) {
                     return "⚠️ The language model is still loading. Please wait a moment.";
                 }
 
                 try {
                     const generated = await distilGPT2(prompt, { max_length: 100, num_return_sequences: 1 });
                     if (generated && generated.length > 0) {
                         const response = generated[0].generated_text.trim();
                         return response;
                     } else {
                         return "❌ I couldn't generate a response at the moment.";
                     }
                 } catch (error) {
                     console.error("DistilGPT-2 Generation Error:", error);
                     return "❌ An error occurred while generating a response.";
                 }
             }
 
             async respond(input) {
                 console.log("Chatbot received input:", input);
                 input = input.toLowerCase();
                 input = this.correctSpelling(input);
 
                 if (input === "simplify your answer") {
                     return await this.simplifyLastAnswer();
                 }

                 if (this.isQuadraticRequest(input) || this.isQuadraticEquation(input)) {
                    const equation = this.extractQuadraticEquation(input);
                    if (equation) {
                        const steps = this.solveQuadraticEquation(equation);
                        this.lastAnswer = steps.join('<br>');
                        return steps.join('<br>');
                    } else {
                        return "❗ I couldn't parse the quadratic equation. Please ensure it's in the form ax² + bx + c = 0.";
                    }
                }
 
                 if (input === "improve your answer") {
                     return await this.improveLastAnswer();
                 }

                 if (input.toLowerCase().endsWith("information")) {
                    const country = input.replace("information", "").trim();
                    if (country) {
                        const countryInfo = await fetchCountryInfo(country);
                        return countryInfo;
                    } else {
                        return "❌ Please specify a country to get information about.";
                    }
                }


                 if (input.startsWith('define ')) {
                    const theWord = input.replace('define ', '').trim();
                    return await fetchDefinition(theWord);
                    }

                 const whoPattern = /^who\s+is\s+(.+)$/i;
                const wherePattern = /^where\s+is\s+(.+)$/i;
                const tellMePattern = /^tell\s+me\s+about\s+(.+)$/i;

                let match;
                
                if ((match = input.match(whoPattern))) {
                    const entity = match[1].trim();

                    const wikiResponse = await this.fetchWikipedia(entity);

                    const ddgResponse = await this.fetchDuckDuckGo(entity);
                    return this.buildAggregatedSnippet(wikiResponse, ddgResponse);
                }

                if ((match = input.match(wherePattern))) {
                    const entity = match[1].trim(); 
                    const wikiResponse = await this.fetchWikipedia(entity);
                    const ddgResponse = await this.fetchDuckDuckGo(entity);
                    return this.buildAggregatedSnippet(wikiResponse, ddgResponse);
                }

                if ((match = input.match(tellMePattern))) {
                    const entity = match[1].trim(); 
                    const wikiResponse = await this.fetchWikipedia(entity);
                    const ddgResponse = await this.fetchDuckDuckGo(entity);
                    return this.buildAggregatedSnippet(wikiResponse, ddgResponse);
                }

                if (input.split(' ').length === 1) {

                    const wikiResponse = await this.fetchWikipedia(input);
                    const ddgResponse = await this.fetchDuckDuckGo(input);
                    return this.buildAggregatedSnippet(wikiResponse, ddgResponse);
                }


                 const videoPattern = /^show video about (.+)$/i;
                 const videoMatch = input.match(videoPattern);
                    if (videoMatch) {
                        const query = videoMatch[1].trim().toLowerCase();

                        const videoURL = this.getHardcodedVideoURL(query);
                        if (videoURL) {
                            const response = `<iframe width="560" height="315" src="${videoURL}" frameborder="0" allowfullscreen></iframe>`;
                            this.lastAnswer = response; 
                            return response;
                        } else {
                            const response = `❌ I don't have a video for **${query}**.`;
                            this.lastAnswer = response;
                            return response;
                        }
                    }
 
                 const imagePattern = /^show image of (.+)$/i;
                 const imageMatch = input.match(imagePattern);
                 if (imageMatch) {
                     const query = imageMatch[1].trim();
                     const imageURL = await this.fetchImage(query);
                     if (imageURL) {
                         const response = `<img src="${imageURL}" alt="${query}" style="max-width:100%; border-radius:10px;"/>`;
                         this.lastAnswer = response; 
                         return response;
                     } else {
                         const response = `❌ I couldn't find an image for **${query}**.`;
                         this.lastAnswer = response;
                         return response;
                     }
                 }

                input = input.toLowerCase();
                input = this.correctSpelling(input);

                if (this.isQuadraticRequest(input) || this.isQuadraticEquation(input)) {
                    const equation = this.extractQuadraticEquation(input);
                    if (equation) {
                        const steps = this.solveQuadraticEquation(equation);
                        this.lastAnswer = steps.join('<br>');
                        return steps.join('<br>');
                    } else {
                        return "❗ I couldn't parse the quadratic equation. Please ensure it's in the form ax² + bx + c = 0.";
                    }
                }
 
                 const wordLimitPattern = /^what is (.+?) in (\d+) words$/i;
                 const wordLimitMatch = input.match(wordLimitPattern);
                 if (wordLimitMatch) {
                     const topic = wordLimitMatch[1].trim();
                     const wordCount = parseInt(wordLimitMatch[2], 10);
 
                     if (isNaN(wordCount) || wordCount <= 0) {
                         const response = "❗ Please specify a valid number of words. For example: 'What is photosynthesis in 300 words?'.";
                         this.lastAnswer = response;
                         return response;
                     }
 
                     const maxWordCount = 2000;
                     if (wordCount > maxWordCount) {
                         const response = `❗ Please specify a word count less than or equal to ${maxWordCount} words.`;
                         this.lastAnswer = response;
                         return response;
                     }
 
                     const essay = await this.fetchLongEssay(topic, wordCount);
                     console.log("Chatbot response:", essay);
                     this.lastAnswer = essay;
                     return essay;
                 }
 
                 if (input.includes("what is") && input.includes("in bullet points")) {
                     const topic = input.replace("what is", "").replace("in bullet points", "").trim();
                     if (!topic) {
                         const response = "❗ Please specify the topic you want me to explain in bullet points. For example: 'What is photosynthesis in bullet points?'.";
                         this.lastAnswer = response;
                         return response;
                     }
                     const bulletPoints = await this.fetchBulletPoints(topic, 7);
                     console.log("Chatbot response:", bulletPoints);
                     this.lastAnswer = bulletPoints;
                     return bulletPoints;
                 }
 
                 if (input.includes("what is") && input.includes("in 1000 words")) {
                     const topic = input.replace("what is", "").replace("in 1000 words", "").trim();
                     if (!topic) {
                         const response = "❗ Please specify the topic you want me to explain in 1000 words. For example: 'What is photosynthesis in 1000 words?'.";
                         this.lastAnswer = response;
                         return response;
                     }
                     const essay = await this.fetchLongEssay(topic, 1000);
                     console.log("Chatbot response:", essay);
                     this.lastAnswer = essay;
                     return essay;
                 }
 
                 if (input.includes("thank you") || input.includes("thanks")) {
                     const thankYouResponses = [
                         "You're welcome! 😊 How are you today?",
                         "No problem! 😄 Is there anything else I can help you with?",
                         "Glad to help! 😎 What can I assist you with next?",
                         "Always happy to help! 🤗 Need anything else?"
                     ];
                     const response = thankYouResponses[Math.floor(Math.random() * thankYouResponses.length)];
                     console.log("Chatbot response:", response);
                     this.lastAnswer = response;
                     return response;
                 }
 
                 if (input.includes("hello") || input.includes("hi")) {
                     const greetings = [
                         "Hello! 😊 How can I assist you today?",
                         "Hi there! 👋 What can I do for you?",
                         "Hey! 😊 Need any help today?"
                     ];
                     const response = greetings[Math.floor(Math.random() * greetings.length)];
                     console.log("Chatbot response:", response);
                     this.lastAnswer = response;
                     return response;
                 }
 
                 if (input.includes("bye")) {
                     const farewells = [
                         "Goodbye! Have a wonderful day! 👋",
                         "See you later! Take care! 😊",
                         "Bye! Feel free to reach out if you need anything else! 👋"
                     ];
                     const response = farewells[Math.floor(Math.random() * farewells.length)];
                     console.log("Chatbot response:", response);
                     this.lastAnswer = response;
                     return response;
                 }
 
                 if (input.includes("how are you")) {
                     const wellbeingResponses = [
                         "I'm here to help! 😊 How can I support you today?",
                         "I'm doing great, thank you! How about you? 😊",
                         "Everything's awesome on my end! How can I assist you?"
                     ];
                     const response = wellbeingResponses[Math.floor(Math.random() * wellbeingResponses.length)];
                     console.log("Chatbot response:", response);
                     this.lastAnswer = response;
                     return response;
                 }
 
                 if (input.includes("joke")) {
                     const joke = this.getRandomJoke();
                     console.log("Chatbot response:", joke);
                     this.lastAnswer = joke;
                     return joke;
                 }
 
 
                 if (input.includes("riddle")) {
                     const riddle = this.getRandomRiddle();
                     console.log("Chatbot response:", riddle);
                     this.lastAnswer = riddle;
                     return riddle;
                 }
 
                 if (input.includes("tell me a story")) {
                     const story = this.getRandomStory();
                     console.log("Chatbot response:", story);
                     this.lastAnswer = story;
                     return story;
                 }
 
 
                 if (input.includes("create an email about")) {
                     this.createEmailForm(input);
                     const response = "📧 Let's compose that email together!";
                     console.log("Chatbot response:", response);
                     this.lastAnswer = response;
                     return response;
                 }
 
 
                 if (input.includes("graph")) {
                     const response = this.promptForGraphData();
                     console.log("Chatbot response:", response);
                     this.lastAnswer = response;
                     return response;
                 }
 
                 if (input === 'list languages') {
                     const languages = Object.keys(this.languageCodes).join(', ');
                     const response = `🌐 I can translate to the following languages: ${languages}. Which one would you like to use?`;
                     console.log("Chatbot response:", response);
                     this.lastAnswer = response;
                     return response;
                 }
 
                 if (input.startsWith('translate to')) {
                     const parts = input.split(' ');
                     if (parts.length >= 3) {
                         const langName = parts[2];
                         const langCode = this.languageCodes[langName];
                         if (!langCode) {
                             const response = `❗ Sorry, I don't support the language '${langName}'. Please try another language.`;
                             console.log("Chatbot response:", response);
                             this.lastAnswer = response;
                             return response;
                         }
                         const textToTranslate = parts.slice(3).join(' ');
                         if (!textToTranslate) {
                             const response = "❗ Please provide the text you want me to translate.";
                             console.log("Chatbot response:", response);
                             this.lastAnswer = response;
                             return response;
                         }
 
                         const translatedText = await this.translateText(textToTranslate, langCode);
                         if (translatedText.startsWith("⚠️")) {
                             console.log("Chatbot response:", translatedText);
                             this.lastAnswer = translatedText;
                             return translatedText;
                         }
                         const prefix = this.translations[langName] || '';
                         const response = `📝 **Translation (${langName}):** ${prefix}${translatedText}`;
                         console.log("Chatbot response:", response);
                         this.lastAnswer = response;
                         return response;
                     } else {
                         const response = "❗ Please specify the target language and the text to translate. For example: 'translate to Spanish Hello, how are you?'.";
                         console.log("Chatbot response:", response);
                         this.lastAnswer = response;
                         return response;
                     }
                 }
 
                 if (this.isMathExpression(input)) {
                     const mathResult = this.solveMath(input);
                     console.log("Chatbot response:", mathResult);
                     this.lastAnswer = mathResult;
                     return mathResult;
                 }
 
                 if (input.includes("what is")) {
                     const aggregatedAnswer = await this.generateAggregatedAnswer(input);
                     console.log("Chatbot response:", aggregatedAnswer);
                     this.lastAnswer = aggregatedAnswer;
                     return aggregatedAnswer;
                 }
 
                 if (input.includes("write an essay on")) {
                     const topic = input.replace("write an essay on", "").trim();
                     const essay = await this.fetchEssay(topic);
                     console.log("Chatbot response:", essay);
                     this.lastAnswer = essay;
                     return essay;
                 }
 
 
                 if (input.includes("multiplication")) {
                     const response = `✏️ **Mnemonic for Multiplication:** ${this.mnemonics["multiplication"]}`;
                     console.log("Chatbot response:", response);
                     this.lastAnswer = response;
                     return response;
                 }
 
                 if (input.includes("division")) {
                     const response = `✏️ **Mnemonic for Division:** ${this.mnemonics["division"]}`;
                     console.log("Chatbot response:", response);
                     this.lastAnswer = response;
                     return response;
                 }
 
                 // Use DistilGPT-2 for unmatched inputs
                 const distilGPT2Response = await this.generateDistilGPT2Response(input);
                 console.log("Chatbot response:", distilGPT2Response);
                 this.lastAnswer = distilGPT2Response;
                 return distilGPT2Response;
             }
 
             async simplifyLastAnswer() {
                 if (this.lastAnswer) {
                     const words = this.lastAnswer.split(/\s+/);
                     if (words.length <= 100) {
                         const response = "❗ The previous answer is too short to simplify further.";
                         console.log("Chatbot response:", response);
                         this.lastAnswer = response;
                         return response;
                     }
                     const simplifiedWords = words.slice(0, words.length - 100);
                     const simplifiedText = simplifiedWords.join(' ') + '...';
                     console.log("Chatbot response:", simplifiedText);
                     this.lastAnswer = simplifiedText;
                     return simplifiedText;
                 } else {
                     const response = "❗ I don't have any previous answer to simplify.";
                     console.log("Chatbot response:", response);
                     return response;
                 }
             }
 
             async improveLastAnswer() {
                 if (this.lastAnswer) {
                     const additionalText = " This additional information provides a deeper understanding and more comprehensive insight into the topic, enhancing the overall explanation and making it more informative for better comprehension and learning.";
                     const words = additionalText.split(/\s+/);
                     if (words.length >= 100) {
                         const expandedText = this.lastAnswer + ' ' + additionalText;
                         console.log("Chatbot response:", expandedText);
                         this.lastAnswer = expandedText;
                         return expandedText;
                     } else {
                         const response = "❗ Unable to add sufficient words to improve the answer.";
                         console.log("Chatbot response:", response);
                         this.lastAnswer = response;
                         return response;
                     }
                 } else {
                     const response = "❗ I don't have any previous answer to improve.";
                     console.log("Chatbot response:", response);
                     return response;
                 }
             }
 
             detectLanguage(input) {
                 const languages = ["python", "lua", "java", "javascript", "c++"];
                 for (let lang of languages) {
                     if (input.includes(lang)) {
                         return lang;
                     }
                 }
                 return null;
             }
 
             detectFunctionality(input) {
                 if (input.includes("chatbot") || input.includes("bot")) {
                     return "chatbot";
                 } else if (input.includes("web server") || input.includes("server")) {
                     return "web_server";
                 }
                 return null;
             }
 
             generateCode(language, functionality) {
                 const template = this.codeTemplates[language] && this.codeTemplates[language][functionality];
                 if (template) {
                     return `💻 Here's a **${language}** code snippet to **${functionality}**:\n\`\`\`${language}\n${template}\n\`\`\``;
                 } else {
                     return `❌ Sorry, I don't have a template for a **${language}** **${functionality}**.`;
                 }
             }
 
             correctSpelling(input) {
                 const words = input.split(" ");
                 return words.map(word => this.misspellings[word.toLowerCase()] || word).join(" ");
             }
 
             getRandomStory() {
                 return this.stories[Math.floor(Math.random() * this.stories.length)];
             }
 
             getRandomJoke() {
                 return this.jokes[Math.floor(Math.random() * this.jokes.length)];
             }
 
             getRandomRiddle() {
                 return this.riddles[Math.floor(Math.random() * this.riddles.length)];
             }
 
             async fetchBulletPoints(topic, maxPoints = 7) { 
                 try {
                     const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`);
                     const data = await response.json();
                     if (data.extract) {
                         const sentences = data.extract.split('. ').filter(sentence => sentence.trim() !== '');
                         const bulletPoints = sentences.slice(0, maxPoints).map(sentence => `<li>${sentence.trim()}.</li>`).join('');
                         const responseText = `📝 **${topic.charAt(0).toUpperCase() + topic.slice(1)}:**\n<ul>${bulletPoints}</ul>`;
                         return responseText;
                     } else {
                         return `❌ Sorry, I couldn't find information on **${topic}**.`;
                     }
                 } catch (error) {
                     console.error("Bullet Points Fetch Error:", error);
                     return `⚠️ Error fetching information on **${topic}**.`;
                 }
             }
 
             async fetchLongEssay(topic, wordCount) {
                 try {
                     const response = await fetch(`https://en.wikipedia.org/w/api.php?action=query&prop=extracts&titles=${encodeURIComponent(topic)}&format=json&origin=*`);
                     const data = await response.json();
                     const pages = data.query.pages;
                     const page = pages[Object.keys(pages)[0]];
                     if (page.extract) {
                         const parser = new DOMParser();
                         const doc = parser.parseFromString(page.extract, 'text/html');
                         const text = doc.body.textContent || "";
                         const wordsArray = text.split(/\s+/);
                         const essayWords = wordsArray.slice(0, wordCount);
                         const essay = essayWords.join(' ');
                         return `📝 Here's an essay on **${topic}**:\n\n${essay}`;
                     } else {
                         return `❌ Sorry, I couldn't find enough information on **${topic}**.`;
                     }
                 } catch {
                     return `⚠️ Error fetching the essay on **${topic}**.`;
                 }
             }

             
 
             async fetchWikipedia(query) {
                 const searchTerm = query.replace("what is", "").trim();
                 try {
                     const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(searchTerm)}`);
                     const data = await response.json();
                     if (data.extract) {
                         return `📚 *From Wikipedia:* ${data.extract.split('. ').slice(0, 2).join('. ')}.`;
                     } else {
                         return "❌ I couldn't find information on that topic.";
                     }
                 } catch {
                     return "⚠️ I couldn't fetch the information from Wikipedia.";
                 }
             }
 
             isMathExpression(input) {
                 return /(\d+[\+\-\*\/\^\(\)\s]+[\d\+\-\*\/\^\(\)\s]+)/g.test(input);
             }
 
             solveMath(problem) {
                 try {
                     problem = problem.replace(/\^/g, '**').replace(/sqrt\(/g, 'sqrt(');
                     const result = math.evaluate(problem);
                     return `🧮 The result is ${result}.`;
                 } catch (error) {
                     console.error("Math Solving Error:", error);
                     return "⚠️ Sorry, I couldn't calculate that.";
                 }
             }
 
             promptForGraphData() {
                 return "📈 Please provide the data you'd like to graph in the format: x1, y1; x2, y2; ...";
             }
 
             async fetchEssay(topic) {
                 try {
                     const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`);
                     const data = await response.json();
                     if (data.extract) {
                         const sentences = data.extract.split(". ");
                         const essay = sentences.slice(0, Math.min(50, sentences.length)).join(". ") + ".";
                         return `📝 Here's a brief essay on **${topic}**:\n\n${essay}`;
                     } else {
                         return `❌ Sorry, I couldn't find enough information on **${topic}**.`;
                     }
                 } catch {
                     return `⚠️ Error fetching the essay on **${topic}**.`;
                 }
             }
 
             createEmailForm(input) {
                 document.getElementById('email-container').classList.add('active');
                 const subject = input.replace("create an email about", "").trim();
                 document.getElementById('email-subject').value = subject;
             }
 
             async translateText(text, targetLanguage) {
                 const translateEndpoint = 'https://libretranslate.de/translate';
 
                 try {
                     const response = await fetch(translateEndpoint, {
                         method: 'POST',
                         body: JSON.stringify({
                             q: text,
                             source: 'auto',
                             target: targetLanguage,
                             format: 'text'
                         }),
                         headers: { 
                             'Content-Type': 'application/json'
                         }
                     });
 
                     if (!response.ok) {
                         const errorText = await response.text();
                         console.error(`Translation API Error (${translateEndpoint}): ${response.status} - ${errorText}`);
                         return "⚠️ Error translating the text. Please try again later.";
                     }
 
                     const data = await response.json();
                     if (data.error) {
                         console.error(`Translation API Error (${translateEndpoint}): ${data.error}`);
                         return "⚠️ Error translating the text. Please try again later.";
                     }
                     return data.translatedText;
                 } catch (error) {
                     console.error(`Translation Error (${translateEndpoint}): ${error}`);
                     return "⚠️ Error translating the text. Please try again later.";
                 }
             }
 
             async generateAggregatedAnswer(query) {
                 try {
                     const wikiResponse = await this.fetchWikipedia(query);
                     const duckDuckGoResponse = await this.fetchDuckDuckGo(query);
 
                     let aggregated = `<div class="aggregated-answer">`;
                     aggregated += `<h4>📚 Aggregated Information:</h4>`;
                     if (wikiResponse !== "❌ I couldn't find information on that topic." && wikiResponse !== "⚠️ I couldn't fetch the information from Wikipedia.") {
                         aggregated += `<p><strong>Wikipedia:</strong> ${wikiResponse}</p>`;
                     }
                     if (duckDuckGoResponse !== "❌ DuckDuckGo could not find an instant answer for that query.") {
                         aggregated += `<p><strong>DuckDuckGo:</strong> ${duckDuckGoResponse}</p>`;
                     }
                     aggregated += `</div>`;
                     return aggregated;
                 } catch (error) {
                     console.error("Aggregated Answer Error:", error);
                     return "⚠️ Sorry, I couldn't retrieve information from multiple sources at this time.";
                 }
             }
 
             async fetchDuckDuckGo(query) {
                 const encodedQuery = encodeURIComponent(query);
                 const url = `https://api.duckduckgo.com/?q=${encodedQuery}&format=json&no_redirect=1&no_html=1`;
 
                 try {
                     const response = await fetch(url);
                     if (!response.ok) {
                         console.error(`DuckDuckGo API Error: ${response.status}`);
                         return "❌ Unable to retrieve data from DuckDuckGo.";
                     }
 
                     const data = await response.json();
                     if (data.AbstractText) {
                         let imageHTML = "";
                         if (data.Image) {
                             let imageURL = data.Image;
                             if (imageURL && !imageURL.startsWith('http')) {
                                 imageURL = `https://duckduckgo.com${imageURL}`;
                             }
                             imageHTML = `<img src="${imageURL}" alt="${query}" style="max-width: 100%; border-radius: 10px; margin-top: 10px; box-shadow: none;">`;
                         }
                         return `${data.AbstractText}. ${imageHTML}`;
                     } else if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                         const firstTopic = data.RelatedTopics[0];
                         let topicText = firstTopic.Text || "";
                         let imageHTML = "";
                         if (firstTopic.Icon && firstTopic.Icon.URL) {
                             let imageURL = firstTopic.Icon.URL;
                             if (imageURL && !imageURL.startsWith('http')) {
                                 imageURL = `https://duckduckgo.com${imageURL}`;
                             }
                             imageHTML = `<img src="${imageURL}" alt="${query}" style="max-width: 100%; border-radius: 10px; margin-top: 10px; box-shadow: none;">`;
                         }
                         return `${topicText}. ${imageHTML}`;
                     } else {
                         return "❌ DuckDuckGo could not find an instant answer for that query.";
                     }
                 } catch (error) {
                     console.error("DuckDuckGo Fetch Error:", error);
                     return "❌ Unable to retrieve data from DuckDuckGo.";
                 }
             }

             buildAggregatedSnippet(wikiResponse, ddgResponse) {
                let snippet = `<div class="aggregated-answer">`;
                snippet += `<h4>📚 Aggregated Information:</h4>`;

                if (
                    wikiResponse !== "❌ I couldn't find information on that topic." &&
                    wikiResponse !== "⚠️ I couldn't fetch the information from Wikipedia."
                ) {
                    snippet += `<p><strong>Wikipedia:</strong> ${wikiResponse}</p>`;
                }

                if (ddgResponse !== "❌ DuckDuckGo could not find an instant answer for that query.") {
                    snippet += `<p><strong>DuckDuckGo:</strong> ${ddgResponse}</p>`;
                }

                snippet += `</div>`;
                return snippet;
                }

 
             async generateGPT2Response(input) {
                 if (!this.gpt2Loaded || !this.gpt2Model) {
                     return "⚠️ ByteBuddy Gen 2 model is not loaded yet. Please wait a moment.";
                 }
 
                 try {
                     const encodedInput = this.encodeInput(input);
                     const inputTensor = tf.tensor2d([encodedInput], [1, encodedInput.length]);
                     const predictions = await this.gpt2Model.executeAsync({ 'input_ids': inputTensor });
                     const decodedOutput = this.decodeOutput(predictions);
                     tf.dispose([inputTensor, predictions]);
                     return `🤖 ByteBuddy Gen 2: ${decodedOutput}`;
                 } catch (error) {
                     console.error("GPT-2 Inference Error:", error);
                     return "❌ An error occurred while generating a response with ByteBuddy Gen 2.";
                 }
             }
 
             encodeInput(text) {
                 return text.split('').map(char => char.charCodeAt(0));
             }
 
             decodeOutput(predictions) {
                 const outputArray = predictions.dataSync();
                 return String.fromCharCode(...outputArray).trim();
             }
 
             generateImageDescription(objects) {
                 if (!objects || objects.length === 0) {
                     return "❓ I'm not sure what's in the image.";
                 }
 
                 let description = `📝 Here's a description of the image you uploaded:\n\n`;
                 let objectList = objects.join(', ');
                 description += `The image contains the following objects: ${objectList}. `;
                 description += `In this scene, these elements interact in a unique way, creating a visually engaging composition. The presence of these objects suggests a specific setting and context, which adds depth and meaning to the overall image. Each item contributes to the narrative, making the image both informative and aesthetically pleasing. `;
 
                 return description;
             }

             isQuadraticRequest(input) {
        const quadraticKeywords = [
            'solve quadratic',
            'quadratic equation',
            'solve ax² + bx + c = 0',
            'solve ax^2 + bx + c = 0',
            'solve a quadratic equation',
            'find roots of'
        ];
        return quadraticKeywords.some(keyword => input.includes(keyword));
    }

    isQuadraticEquation(input) {
        const quadraticRegex = /(-?\d*\.?\d*)x\^2\s*([\+\-]\s*\d*\.?\d*)x\s*([\+\-]\s*\d*\.?\d*)\s*=\s*0/i;
        return quadraticRegex.test(input.replace(/\s+/g, ''));
    }

    extractQuadraticEquation(input) {
        const equationRegex = /(-?\d*\.?\d*)x\^2\s*([\+\-]\s*\d*\.?\d*)x\s*([\+\-]\s*\d*\.?\d*)\s*=\s*0/i;
        const match = input.match(equationRegex);
        if (match) {
            return {
                a: parseFloat(match[1]) || 1,
                b: parseFloat(match[2].replace(/\s+/g, '')) || 0,
                c: parseFloat(match[3].replace(/\s+/g, '')) || 0
            };
        }
        return null;
    }

    solveQuadraticEquation(equation) {
        const { a, b, c } = equation;
        const steps = [];

        steps.push(`🧮 **Solving the quadratic equation:** ${a}x² + ${b}x + ${c} = 0`);

        const discriminant = b * b - 4 * a * c;
        steps.push(`1️⃣ **Calculate the discriminant (Δ):**`);
        steps.push(`   Δ = b² - 4ac`);
        steps.push(`   Δ = (${b})² - 4 * ${a} * ${c}`);
        steps.push(`   Δ = ${b * b} - ${4 * a * c}`);
        steps.push(`   Δ = ${discriminant}`);

        steps.push(`2️⃣ **Determine the nature of the roots based on Δ:**`);
        if (discriminant > 0) {
            steps.push(`   Since Δ > 0, there are two distinct real roots.`);
        } else if (discriminant === 0) {
            steps.push(`   Since Δ = 0, there is one real root (a repeated root).`);
        } else {
            steps.push(`   Since Δ < 0, there are two complex roots.`);
        }

        steps.push(`3️⃣ **Calculate the roots using the quadratic formula:**`);
        steps.push(`   The quadratic formula is x = (-b ± √Δ) / (2a)`);
        steps.push(`   Substitute the values: x = (-(${b}) ± √${discriminant}) / (2 * ${a})`);

        if (discriminant >= 0) {
            const sqrtDelta = Math.sqrt(discriminant);
            const root1 = ((-b + sqrtDelta) / (2 * a)).toFixed(3);
            const root2 = ((-b - sqrtDelta) / (2 * a)).toFixed(3);
            steps.push(`   √Δ = √${discriminant} = ${sqrtDelta.toFixed(3)}`);
            steps.push(`   x₁ = (-${b} + ${sqrtDelta.toFixed(3)}) / ${2 * a} = ${root1}`);
            steps.push(`   x₂ = (-${b} - ${sqrtDelta.toFixed(3)}) / ${2 * a} = ${root2}`);
        } else {
            const sqrtDelta = Math.sqrt(-discriminant);
            const realPart = (-b / (2 * a)).toFixed(3);
            const imaginaryPart = (sqrtDelta / (2 * a)).toFixed(3);
            steps.push(`   √Δ = √${discriminant} = ${sqrtDelta.toFixed(3)}i`);
            steps.push(`   x₁ = (${realPart}) + (${imaginaryPart})i`);
            steps.push(`   x₂ = (${realPart}) - (${imaginaryPart})i`);
        }

        return steps;
    }
 
             async fetchImage(query) {
                 try {
                     const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_redirect=1&no_html=1&skip_disambig=1`);
                     const data = await response.json();
                     if (data.Image) {
                         let imageURL = data.Image;
                         if (imageURL && !imageURL.startsWith('http')) {
                             imageURL = `https://duckduckgo.com${imageURL}`;
                         }
                         return imageURL;
                     } else if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                         const firstTopic = data.RelatedTopics[0];
                         if (firstTopic.Icon && firstTopic.Icon.URL) {
                             let imageURL = firstTopic.Icon.URL;
                             if (imageURL && !imageURL.startsWith('http')) {
                                 imageURL = `https://duckduckgo.com${imageURL}`;
                             }
                             return imageURL;
                         }
                     }
                     return null;
                 } catch (error) {
                     console.error("Image Fetch Error:", error);
                     return null;
                 }
             }
         }
 
         let chatbot;
 
         async function initializeChatbot() {
             chatbot = new Chatbot();
         }
 
 
         async function loadModel() {
             displayMessage("🔄 Loading image recognition model...", "bot-message");
             const uploadButton = document.getElementById('upload-image-button');
 
             uploadButton.classList.add('disabled');
             uploadButton.innerHTML = `📷 Upload Image <span class="loader"></span>`;
 
             try {
                 model = await mobilenet.load();
                 modelLoaded = true;
                 displayMessage("✅ Image recognition model loaded and ready to use!", "bot-message");
                 uploadButton.classList.remove('disabled');
                 uploadButton.innerHTML = "📷 Upload Image";
             } catch (error) {
                 displayMessage("❌ Failed to load the image recognition model.", "bot-message");
                 console.error(error);
 
                 const existingRetryButton = uploadButton.parentElement.querySelector('.retry-button');
                 if (!existingRetryButton) {
                     const retryButton = document.createElement('button');
                     retryButton.textContent = "🔄 Retry Loading Model";
                     retryButton.className = "retry-button";
                     retryButton.style.marginTop = "10px";
                     retryButton.style.padding = "10px 20px";
                     retryButton.style.border = "none";
                     retryButton.style.borderRadius = "10px";
                     retryButton.style.backgroundColor = "rgba(76, 161, 175, 0.6)";
                     retryButton.style.color = "white";
                     retryButton.style.cursor = "pointer";
                     retryButton.style.fontSize = "16px";
                     retryButton.onclick = loadModel;
 
                     uploadButton.parentElement.appendChild(retryButton);
                 }
             }
         }
 
         async function triggerImageUpload() {
             document.getElementById('image-upload').click();
         }
 
         async function handleImageUpload(event) {
             const file = event.target.files[0];
             if (!file) return;
 
             if (!file.type.startsWith('image/')) {
                 displayMessage("❌ Please upload a valid image file.", "bot-message");
                 return;
             }
 
             const reader = new FileReader();
             reader.onload = function(e) {
                 displayImage(e.target.result);
                 displayMessage("🔍 Analyzing the image...", "bot-message");
                 analyzeImage(e.target.result);
                 performOCR(e.target.result);
             };
             reader.readAsDataURL(file);
         }

         function displayMessage(text, className) {
            const chatbox = document.getElementById('chatbox');
            const div = document.createElement('div');
            div.className = `message ${className}`;
            div.innerHTML = text;   
            chatbox.appendChild(div);
            chatbox.scrollTop = chatbox.scrollHeight;
            }

            async function extractTableDataFromImage(imageSrc) {
            try {
                const { data: { text } } = await Tesseract.recognize(imageSrc, 'eng', {
                logger: m => console.log(m) 
                });
                return text;
            } catch (error) {
                console.error("OCR Error:", error);
                return null;
            }
            }

            function parseTableText(ocrText) {
            if (!ocrText) return [];

            const lines = ocrText.split('\n').map(line => line.trim()).filter(Boolean);

            const table = lines.map(line => {

                return line.split(/\s+/);
            });

            return table; 
            }

            function convertToChartData(table) {
                if (table.length < 2) return null;
                const headers = table[0];  
                const dataRows = table.slice(1);

                const columns = {};
                headers.forEach(header => {
                    columns[header] = [];
                });

                dataRows.forEach(row => {
                    row.forEach((cell, index) => {
                    const header = headers[index];
                    columns[header].push(cell);
                    });
                });

                return { headers, columns };
                }

                function createChartForColumn(columnName, chartDataObj) {
                const numericValues = chartDataObj.columns[columnName].map(val => Number(val));

                const labels = chartDataObj.columns["Name"]; 

                const canvasId = 'chart-' + Date.now();
                const canvasHTML = `<canvas id="${canvasId}" width="400" height="300"></canvas>`;

                displayMessage(canvasHTML, 'bot-message');

                requestAnimationFrame(() => {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    new Chart(ctx, {
                    type: 'bar', 
                    data: {
                        labels,
                        datasets: [{
                        label: columnName,
                        data: numericValues,
                        backgroundColor: 'rgba(76, 161, 175, 0.6)',
                        borderColor: 'rgba(76, 161, 175, 1)',
                        borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                        y: {
                            beginAtZero: true
                        }
                        }
                    }
                    });
                });
                }
            async function fetchDefinition(word) {
            const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                return `❌ Could not find a definition for "${word}".`;
                }
                const data = await response.json();
                if (data && Array.isArray(data) && data[0].meanings) {
                const definition = data[0].meanings[0].definitions[0].definition;
                return `📖 **Definition of ${word}:** ${definition}`;
                }
                return "No definition found.";
            } catch (err) {
                console.error(err);
                return "Error fetching definition.";
            }
            }

         function isMathExpression(input) {
            return /[\d+\-*/^().]/.test(input);
            }

            function solveMathStepByStep(expression) {
            expression = expression.replace(/\s+/g, '');
            const steps = [];
            steps.push(`1) Identified expression: \`${expression}\``);
            try {
                const result = math.evaluate(expression);
                steps.push("2) Evaluate using math.js internally");
                steps.push(`3) Final result: **${result}**`);
            } catch (error) {
                steps.push(`❌ Could not evaluate: ${error.message}`);
            }
            return `<ul>${steps.map(s => `<li>${s}</li>`).join('')}</ul>`;
            }

         function sendTextMessage() {
            const inputEl = document.getElementById('user-input');
            const userMessage = inputEl.value.trim();
            if (!userMessage) return;

        displayMessage(userMessage, "user-message");
            inputEl.value = "";

            if (isMathExpression(userMessage)) {
                const stepsHtml = solveMathStepByStep(userMessage);
                displayMessage(stepsHtml, "bot-message");
            } else {
                displayMessage("I'll try to handle math questions step by step. Please input math expressions!", "bot-message");
            }
            }
 
         function displayImage(imageSrc) {
             const chatbox = document.getElementById("chatbox");
             const messageDiv = document.createElement("div");
             messageDiv.className = `message user-message`;
 
             const img = document.createElement("img");
             img.src = imageSrc;
             img.alt = "Uploaded Image";
             img.style.maxWidth = "100%";
             img.style.borderRadius = "15px";
             img.style.marginTop = "10px";
 
             messageDiv.appendChild(img);
             chatbox.appendChild(messageDiv);
             chatbox.scrollTop = chatbox.scrollHeight;
         }

         async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageSrc = e.target.result;

                displayMessage(`<img src="${imageSrc}" style="max-width:100%;"/>`, "user-message");


                displayMessage("Performing OCR to detect any math text...", "bot-message");
                try {
                const { data: { text } } = await Tesseract.recognize(imageSrc, 'eng');
                displayMessage(`OCR Result:\n${text}`, "bot-message");


                const expressions = extractMathExpressions(text);
                if (expressions.length === 0) {
                    displayMessage("No math expressions found in screenshot.", "bot-message");
                } else {
                    expressions.forEach(expr => {
                    displayMessage(`Detected math: ${expr}`, "bot-message");
                    const stepsHtml = solveMathStepByStep(expr);
                    displayMessage(stepsHtml, "bot-message");
                    });
                }
                } catch (error) {
                displayMessage("OCR Error: " + error.message, "bot-message");
                }
            };
            reader.readAsDataURL(file);
            }

            function extractMathExpressions(text) {
        const regex = /[0-9()+\-*/^.]+/g;
        return text.match(regex) || [];
        }

 
         async function analyzeImage(imageSrc) {
             if (!modelLoaded) {
                 displayMessage("⚠️ Model not loaded yet. Please try again shortly.", "bot-message");
                 return;
             }
 
             const img = new Image();
             img.src = imageSrc;
             img.crossOrigin = "anonymous";
             img.onload = async function() {
                 try {
                     const predictions = await model.classify(img);
 
                     if (predictions.length > 0) {
                         let response = "📋 I think this image contains:";
                         const objectList = [];
                         predictions.forEach((pred, index) => {
                             response += `<br>${index + 1}. <strong>${pred.className}</strong> (${(pred.probability * 100).toFixed(2)}%)`;
                             objectList.push(pred.className);
                         });
                         displayMessage(response, "bot-message");
 
                         const description = chatbot.generateImageDescription(objectList);
                         displayMessage(description, "bot-message");
                     } else {
                         displayMessage("❓ I couldn't recognize anything in the image.", "bot-message");
                     }
                 } catch (error) {
                     displayMessage("❌ Error during image analysis.", "bot-message");
                     console.error(error);
                 }
             };
             img.onerror = function() {
                 displayMessage("❌ Failed to load the image. Please try again.", "bot-message");
             };
         }
 
         async function performOCR(imageSrc) {
             displayMessage("🔄 Performing OCR to detect math problems...", "bot-message");
             try {
                 const { data: { text } } = await Tesseract.recognize(
                     imageSrc,
                     'eng',
                     { 
                         tessedit_char_whitelist: '0123456789+-*/^sqrt(). ',
                         logger: m => console.log(m)
                     }
                 );
                 console.log("OCR Result:", text);
                 const mathProblems = extractMathProblems(text);
                 if (mathProblems.length > 0) {
                     for (let problem of mathProblems) {
                         const solution = solveMathProblem(problem);
                         displayMessage(`🧮 **Problem:** ${problem}<br>✅ **Solution:** ${solution}`, "bot-message");
                     }
                 } else {
                     displayMessage("❌ I couldn't find any math problems in the image.", "bot-message");
                 }
             } catch (error) {
                 displayMessage("❌ An error occurred while performing OCR.", "bot-message");
                 console.error("OCR Error:", error);
             }
         }
 
         function extractMathProblems(text) {
             const mathRegex = /(\d+[\+\-\*\/\^\(\)\s]+[\d\+\-\*\/\^\(\)\s]+)/g;
             const matches = text.match(mathRegex);
             return matches ? matches.map(expr => expr.replace(/\s+/g, '')) : [];
         }
 
         function solveMathProblem(problem) {
             try {
                 problem = problem.replace(/\^/g, '**').replace(/sqrt\(/g, 'sqrt(');
                 const result = math.evaluate(problem);
                 return result;
             } catch (error) {
                 console.error("Math Solving Error:", error);
                 return "❌ Unable to solve the problem.";
             }
         }
 
         let voiceOutputEnabled = false;
         let voices = [];
 
         function loadVoices() {
             voices = window.speechSynthesis.getVoices();
             if (voices.length === 0) {
                 window.speechSynthesis.onvoiceschanged = () => {
                     voices = window.speechSynthesis.getVoices();
                     populateVoiceList();
                 };
             } else {
                 populateVoiceList();
             }
         }
 
         function populateVoiceList() {
             const voiceSelect = document.getElementById('voice-select');
             if (!voiceSelect) return;
 
             voiceSelect.innerHTML = '<option value="">Select Voice</option>';
             voices.forEach((voice, index) => {
                 const option = document.createElement('option');
                 option.value = index;
                 option.textContent = `${voice.name} (${voice.lang})`;
                 voiceSelect.appendChild(option);
             });
 
             const storedVoiceIndex = localStorage.getItem('selectedVoice');
             if (storedVoiceIndex !== null && voices[storedVoiceIndex]) {
                 voiceSelect.value = storedVoiceIndex;
             }
 
             voiceSelect.addEventListener('change', changeVoice);
         }
 
         function toggleTTSControls() {
             const ttsControls = document.getElementById('tts-controls');
             if (!ttsControls) return;
             ttsControls.style.display = ttsControls.style.display === 'none' || ttsControls.style.display === '' ? 'flex' : 'none';
         }
 
         function toggleVoiceOutput() {
             voiceOutputEnabled = !voiceOutputEnabled;
             localStorage.setItem('voiceOutputEnabled', voiceOutputEnabled);
             
             const voiceOutputButton = document.querySelector('#more-options-dropdown button[onclick="toggleVoiceOutput()"]');
             if (voiceOutputButton) {
                 voiceOutputButton.textContent = voiceOutputEnabled ? '🔊 Voice Output: On' : '🔊 Voice Output: Off';
             }
             
             const ttsControls = document.getElementById('tts-controls');
             if (ttsControls) {
                 ttsControls.style.display = voiceOutputEnabled ? 'flex' : 'none';
             }
         }
 
         function changeVoice() {
             const voiceSelect = document.getElementById('voice-select');
             const selectedIndex = voiceSelect.value;
             if (selectedIndex === "") return;
 
             localStorage.setItem('selectedVoice', selectedIndex);
         }
 
         function playSpeech() {
             if (!voiceOutputEnabled) return;
             if (window.speechSynthesis.paused) {
                 window.speechSynthesis.resume();
             } else {
                 const chatbox = document.getElementById("chatbox");
                 const botMessages = chatbox.querySelectorAll('.bot-message');
                 const lastBotMessage = botMessages.length > 0 ? botMessages[botMessages.length - 1] : null;
                 if (lastBotMessage) {
                     const speechText = lastBotMessage.innerText.replace(/[^a-zA-Z0-9\s.,?!]/g, '');
                     speakText(speechText);
                 }
             }
         }
 
         function pauseSpeech() {
             if (!voiceOutputEnabled) return;
             window.speechSynthesis.pause();
         }
 
         function stopSpeech() {
             if (!voiceOutputEnabled) return;
             window.speechSynthesis.cancel();
         }
 
         function adjustSpeechRate(rate) {
             localStorage.setItem('speechRate', rate);
             if (window.speechSynthesis.speaking) {
                 window.speechSynthesis.cancel();
             }
         }
 
         function speakText(text) {
             if (!voiceOutputEnabled) return;
             if (!window.speechSynthesis) {
                 console.warn('Speech Synthesis not supported in this browser.');
                 return;
             }
 
             window.speechSynthesis.cancel();
 
             const utterance = new SpeechSynthesisUtterance(text);
 
             const voiceSelect = document.getElementById('voice-select');
             if (voiceSelect) {
                 const selectedIndex = voiceSelect.value;
                 if (selectedIndex !== "") {
                     utterance.voice = voices[selectedIndex];
                 } else if (voices.length > 0) {
                     utterance.voice = voices.find(voice => voice.lang === 'en-US') || voices[0];
                 }
             }
 
             const storedRate = parseFloat(localStorage.getItem('speechRate')) || 1;
             utterance.rate = storedRate;
 
             utterance.pitch = 1;
             utterance.volume = 1;
 
             window.speechSynthesis.speak(utterance);
         }
 
         async function typeText(messageDiv, text) {
             const typingSpeed = 1; 
             messageDiv.innerHTML = '';
 
             for (let i = 0; i < text.length; i++) {
                 messageDiv.innerHTML += text.charAt(i);
                 messageDiv.scrollTop = messageDiv.scrollHeight;
                 await new Promise(resolve => setTimeout(resolve, typingSpeed));
             }
 
             const rewriteButton = document.createElement("button");
             rewriteButton.textContent = "🔄 Rewrite";
             rewriteButton.className = "rewrite-button";
             rewriteButton.onclick = () => rewriteMessage(messageDiv, text);
             messageDiv.appendChild(rewriteButton);
 
             const speechText = text.replace(/<[^>]+>/g, '');
             speakText(speechText);
         }

         function displayMessage(text, className) {   console.log("Displaying message:", text, "Class:", className);
            const chatbox = document.getElementById("chatbox");
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${className}`;

            if (text.startsWith("<iframe")) {
                messageDiv.innerHTML = text;
            } else if (text.startsWith("<img")) {
                messageDiv.classList.add("image-message");
                messageDiv.innerHTML = text;
            } else if (text.startsWith("```") && text.endsWith("```")) {
                const pre = document.createElement("pre");
                const code = document.createElement("code");
                
                const languageMatch = text.match(/```(\w+)/);
                const language = languageMatch ? languageMatch[1] : '';
                const codeContent = text.replace(/```(\w+)?\n?/, '').replace(/```$/, '');
                
                code.className = `language-${language}`;
                code.textContent = codeContent;
                pre.appendChild(code);
                messageDiv.appendChild(pre);
                Prism.highlightElement(code);
            } else {
                messageDiv.innerHTML = text; 
            }

            chatbox.appendChild(messageDiv);
            chatbox.scrollTop = chatbox.scrollHeight;

            let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
            chatHistory.push({ text: text, class: className, timestamp: new Date() });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }
 
         function displayMessage(text, className) {
             console.log("Displaying message:", text, "Class:", className);
             const chatbox = document.getElementById("chatbox");
             const messageDiv = document.createElement("div");
             messageDiv.className = `message ${className}`;
 
             if (text.startsWith("```") && text.endsWith("```")) {
                 const pre = document.createElement("pre");
                 const code = document.createElement("code");
                 
                 const languageMatch = text.match(/```(\w+)/);
                 const language = languageMatch ? languageMatch[1] : '';
                 const codeContent = text.replace(/```(\w+)?\n?/, '').replace(/```$/, '');
                 
                 code.className = `language-${language}`;
                 code.textContent = codeContent;
                 pre.appendChild(code);
                 messageDiv.appendChild(pre);
                 Prism.highlightElement(code);
             } 
             else if (text.includes('<div class="aggregated-answer">')) {
                 messageDiv.innerHTML = text;
             } 
             else if (text.startsWith("<img")) {
                 messageDiv.classList.add("image-message");
                 messageDiv.innerHTML = text;
             } 
             else if (text.includes('<ul>') || text.includes('<ol>')) {
                 if (!document.body.classList.contains('simple-mode')) {
                     const keyTerms = ['dyslexia', 'photosynthesis', 'assignment', 'multiplication', 'division'];
                     text = highlightTerms(text, keyTerms);
                 }
                 messageDiv.innerHTML = text;
             } 
             else {
                 if (!document.body.classList.contains('simple-mode')) {
                     const keyTerms = ['dyslexia', 'photosynthesis', 'assignment', 'multiplication', 'division'];
                     text = highlightTerms(text, keyTerms);
                 }
 
                 if (className === "bot-message") {
                     typeText(messageDiv, text);
                 } else {
                     messageDiv.innerHTML = text;
                     addToHistory(text);
                 }
             }
             
             chatbox.appendChild(messageDiv);
             chatbox.scrollTop = chatbox.scrollHeight;
 
             let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
             chatHistory.push({ text: text, class: className, timestamp: new Date() });
             localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
         }

 
         function rewriteMessage(messageDiv, originalText) {
             const existingRewritten = messageDiv.querySelector('.rewritten-message');
             if (existingRewritten) {
                 existingRewritten.remove();
             }
 
             const simplifiedText = simplifyText(originalText);
 
             const rewrittenDiv = document.createElement("div");
             rewrittenDiv.className = "message bot-message rewritten-message";
             rewrittenDiv.innerHTML = `📝 **Rewritten:** ${simplifiedText}`;
             
             messageDiv.appendChild(rewrittenDiv);
             const chatbox = document.getElementById("chatbox");
             chatbox.scrollTop = chatbox.scrollHeight;
         }
 
         function simplifyText(text) {
             const simplificationDictionary = {
                 "utilize": "use",
                 "commence": "start",
                 "endeavor": "try",
                 "facilitate": "help",
                 "approximately": "about",
                 "consequently": "so",
                 "ameliorate": "improve",
                 "perceive": "see",
                 "ascertain": "find out",
                 "disseminate": "spread",
                 "terminate": "end",
                 "demonstrate": "show",
                 "sufficient": "enough",
                 "significant": "important",
                 "predominantly": "mainly",
                 "implement": "carry out",
                 "subsequent": "next",
                 "comprehensive": "complete",
                 "procure": "get",
                 "acquire": "get",
                 "conversely": "on the other hand",
                 "persuade": "convince",
                 "difficult": "hard",
                 "assistance": "help",
                 "expedite": "speed up",
                 "collaborate": "work together",
                 "remuneration": "payment",
                 "inquire": "ask",
                 "depart": "leave",
                 "elucidate": "explain",
                 "necessitate": "require",
                 "create": "make",
                 "generate": "make",
                 "innovate": "create",
             };
 
             const words = text.split(/(\b)/);
             const simplifiedWords = words.map(word => {
                 const lowerCaseWord = word.toLowerCase();
                 if (simplificationDictionary[lowerCaseWord]) {
                     if (word[0] === word[0].toUpperCase()) {
                         return simplificationDictionary[lowerCaseWord].charAt(0).toUpperCase() + simplificationDictionary[lowerCaseWord].slice(1);
                     }
                     return simplificationDictionary[lowerCaseWord];
                 }
                 return word;
             });
             return simplifiedWords.join('');
         }
 
         function addToHistory(message) {
             const historyContent = document.getElementById("history-content");
             const historyMessageDiv = document.createElement("div");
             historyMessageDiv.className = "history-message";
             historyMessageDiv.innerHTML = message;
             historyContent.appendChild(historyMessageDiv);
             historyContent.scrollTop = historyContent.scrollHeight;
         }
 
         function loadHistory() {
             const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
             chatHistory.forEach(entry => {
                 if (entry.class === "user-message") {
                     addToHistory(entry.text);
                 }
             });
         }
 
         function presetOption(option) {
             const homePage = document.getElementById('home-page');
             if (homePage && !homePage.classList.contains('hidden')) {
                 document.getElementById("home-message-input").value = option;
                 startChat();
             } else {
                 document.getElementById("message-input").value = option;
                 sendMessage();
             }
         }
 
         document.getElementById("message-input").addEventListener("input", function(event) {
             this.style.height = 'auto';
             this.style.height = (this.scrollHeight) + 'px';
         });
 
         document.getElementById("message-input").addEventListener("keypress", function(event) {
             if (event.key === "Enter" && !event.shiftKey) {
                 event.preventDefault();
                 sendMessage();
             }
         });
 
         function toggleSimplifyMode() {
             document.body.classList.toggle('simplify-mode');
             const isSimplifyMode = document.body.classList.contains('simplify-mode');
             localStorage.setItem('simplifyMode', isSimplifyMode);
         }
 
         function closeEmailForm() {
             document.getElementById('email-container').classList.remove('active');
         }
 
         function sendEmail(event) {
             event.preventDefault();
             const recipient = document.getElementById('email-recipient').value;
             const subject = document.getElementById('email-subject').value;
             const message = document.getElementById('email-message').value;
 
             displayMessage(`📧 Email sent to ${recipient} with subject "${subject}".`, "bot-message");
             closeEmailForm();
             document.getElementById('email-form').reset();
         }
 
         function initializeSignIn() {
             const signinModal = document.getElementById('signin-modal');
             const signinForm = document.getElementById('signin-form');
             const userNameSpan = document.getElementById('user-name');
 
             const storedName = localStorage.getItem('userName');
             if (storedName) {
                 userNameSpan.textContent = storedName;
             } else {
                 signinModal.classList.add('active');
             }
 
             signinForm.addEventListener('submit', function(event) {
                 event.preventDefault();
                 const userNameInput = document.getElementById('user-name-input').value.trim();
                 if (userNameInput) {
                     localStorage.setItem('userName', userNameInput);
                     userNameSpan.textContent = userNameInput;
                     signinModal.classList.remove('active');
                 }
             });
         }
 
         function openChangeNameModal() {
             const currentName = localStorage.getItem('userName') || 'User';
             const newName = prompt("Enter your new name:", currentName);
             if (newName && newName.trim() !== "") {
                 localStorage.setItem('userName', newName.trim());
                 document.getElementById('user-name').textContent = newName.trim();
                 displayMessage(`👋 Your name has been changed to ${newName.trim()}.`, "bot-message");
             }
         }
 
         const quizzes = [
             {
                 question: "What is 2 + 2?",
                 options: ["3", "4", "5"],
                 answer: "4"
             },
             {
                 question: "What color is the sky on a clear day?",
                 options: ["Blue", "Green", "Red"],
                 answer: "Blue"
             },
         ];
 
         let currentQuiz = 0;
         let score = 0;
 
         function startQuiz() {
             currentQuiz = 0;
             score = 0;
             displayQuiz();
         }
 
         function displayQuiz() {
             if (currentQuiz < quizzes.length) {
                 const quiz = quizzes[currentQuiz];
                 const quizHTML = `
                     <div class="quiz-question">${quiz.question}</div>
                     <div class="quiz-options">
                         ${quiz.options.map(option => `<button class="quiz-option" onclick="selectAnswer('${option}')">${option}</button>`).join('')}
                     </div>
                 `;
                 displayMessage(quizHTML, "bot-message");
             } else {
                 displayMessage(`🎉 Quiz Completed! Your score: ${score} / ${quizzes.length}`, "bot-message");
             }
         }
 
         function selectAnswer(selectedOption) {
             const quiz = quizzes[currentQuiz];
             if (selectedOption === quiz.answer) {
                 score++;
                 displayMessage("✅ Correct! Great job!", "bot-message");
             } else {
                 displayMessage(`❌ Wrong! The correct answer was "${quiz.answer}". Don't worry, keep trying!`, "bot-message");
             }
             currentQuiz++;
             setTimeout(displayQuiz, 1000);
         }
 
         function applyDarkModeBasedOnTime() {
             const now = new Date();
             const hours = now.getHours();
             if (hours >= 17) { 
                 document.body.classList.add('dark-mode');
             }
         }
 
         async function processVoiceInput(text) {
             try {
                 const botResponse = await chatbot.respond(text);
                 displayMessage(botResponse, "bot-message");
                 if (voiceOutputEnabled) {
                     speakText(stripHTML(botResponse));
                 }
             } catch (error) {
                 console.error("Error processing voice input:", error);
                 displayMessage("❌ An error occurred while processing your voice input.", "bot-message");
             }
         }
 
         function stripHTML(html) {
             const div = document.createElement("div");
             div.innerHTML = html;
             return div.textContent || div.innerText || "";
         }
 
         let recognizing = false;
         let recognition;
 
         function initializeSpeechRecognition() {
             const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
             if (!SpeechRecognition) {
                 alert("Sorry, your browser does not support Speech Recognition. Please use Chrome or Edge.");
                 return;
             }
 
             recognition = new SpeechRecognition();
             recognition.continuous = false;
             recognition.interimResults = false;
             recognition.lang = 'en-US';
 
             recognition.onstart = () => {
                 recognizing = true;
                 toggleVoiceButton(true);
                 displayMessage("🔊 Listening...", "bot-message");
             };
 
             recognition.onerror = (event) => {
                 console.error("Speech Recognition Error:", event.error);
                 displayMessage("❌ An error occurred during speech recognition: " + event.error, "bot-message");
                 recognizing = false;
                 toggleVoiceButton(false);
             };
 
             recognition.onend = () => {
                 recognizing = false;
                 toggleVoiceButton(false);
                 document.body.classList.remove('voice-call-active');
                 displayMessage("🔇 Voice call ended.", "bot-message");
             };
 
             recognition.onresult = async (event) => {
                 const transcript = event.results[0][0].transcript.trim();
                 console.log("Recognized Text:", transcript);
                 displayMessage(transcript, "user-message");
                 await processVoiceInput(transcript);
             };
         }
 
         function toggleVoiceCall() {
             if (recognizing) {
                 recognition.stop();
                 recognizing = false;
                 toggleVoiceButton(false);
                 document.body.classList.remove('voice-call-active');
             } else {
                 initializeSpeechRecognition();
                 if (recognition) {
                     recognition.start();
                     document.body.classList.add('voice-call-active');
                 }
             }
         }
 
         function toggleVoiceButton(isActive) {
             const voiceButton = document.getElementById('voice-call-button');
             if (isActive) {
                 voiceButton.classList.add('active');
 
                 if (!voiceButton.querySelector('.loader')) {
                     const loader = document.createElement('div');
                     loader.className = 'loader';
                     voiceButton.appendChild(loader);
                 }
             } else {
                 voiceButton.classList.remove('active');
 
                 const loader = voiceButton.querySelector('.loader');
                 if (loader) {
                     voiceButton.removeChild(loader);
                 }
             }
         }
 
         async function sendMessage() {
             if (isGenerating) {
                 displayMessage("⏳ Please wait while I generate a response...", "bot-message");
                 return;
             }
 
             isGenerating = true;
 
             console.log("sendMessage function called");
             const messageInput = document.getElementById("message-input");
             const userMessage = messageInput.value.trim();
             console.log("User Message:", userMessage);
 
             if (!userMessage) {
                 console.log("No message to send.");
                 isGenerating = false;
                 return;
             }
 
             displayMessage(userMessage, "user-message");
             messageInput.value = "";
             messageInput.style.height = '50px';
 
             const chatbox = document.getElementById("chatbox");
             const typingIndicator = document.createElement("div");
             typingIndicator.className = "message bot-message typing-indicator";
             typingIndicator.innerHTML = `ByteBuddy is typing... <span class="loader"></span>`;
             chatbox.appendChild(typingIndicator);
             chatbox.scrollTop = chatbox.scrollHeight;
 
             try {
                 const botResponse = await chatbot.respond(userMessage);
                 console.log("Bot Response:", botResponse);
 
                 chatbox.removeChild(typingIndicator);
                 displayMessage(botResponse, "bot-message");
             } catch (error) {
                 console.error("Error in sendMessage:", error);
                 displayMessage("❌ An error occurred while processing your message.", "bot-message");
                 chatbox.removeChild(typingIndicator);
             } finally {
                 isGenerating = false;
             }
         }
 
         async function loadDistilGPT2Model() {
             displayMessage("🔄 Loading DistilGPT-2 model...", "bot-message");
             try {
                 distilGPT2 = await window.transformers.pipeline('text-generation', 'Xenova/distilgpt2');
                 displayMessage("✅ DistilGPT-2 model loaded and ready!", "bot-message");
             } catch (error) {
                 displayMessage("❌ Failed to load DistilGPT-2 model.", "bot-message");
                 console.error("Model Loading Error:", error);
             }
         }
 
         async function initializeChatbot() {
             chatbot = new Chatbot();
         }
 
         let isGenerating = false;
 
         async function startChat() {
             const homePage = document.getElementById('home-page');
             const mainContainer = document.getElementById('main-container');
             const homeMessageInput = document.getElementById('home-message-input');
             const userName = localStorage.getItem('userName') || 'User';
 
             const userMessage = homeMessageInput.value.trim();
             if (!userMessage) return;
 
             homePage.classList.add('hidden');
 
             mainContainer.style.display = 'flex';
 
             displayMessage(userMessage, "user-message");
 
             homeMessageInput.value = "";
             homeMessageInput.style.height = '50px';
 
             displayMessage(`Hello, ${userName}! 😊 How can I assist you today?`, "bot-message");
         }
 
         async function loadModel() {
             displayMessage("🔄 Loading image recognition model...", "bot-message");
             const uploadButton = document.getElementById('upload-image-button');
 
             uploadButton.classList.add('disabled');
             uploadButton.innerHTML = `📷 Upload Image <span class="loader"></span>`;
 
             try {
                 model = await mobilenet.load();
                 modelLoaded = true;
                 displayMessage("✅ Image recognition model loaded and ready to use!", "bot-message");
                 uploadButton.classList.remove('disabled');
                 uploadButton.innerHTML = "📷 Upload Image";
             } catch (error) {
                 displayMessage("❌ Failed to load the image recognition model.", "bot-message");
                 console.error(error);
 
                 const existingRetryButton = uploadButton.parentElement.querySelector('.retry-button');
                 if (!existingRetryButton) {
                     const retryButton = document.createElement('button');
                     retryButton.textContent = "🔄 Retry Loading Model";
                     retryButton.className = "retry-button";
                     retryButton.style.marginTop = "10px";
                     retryButton.style.padding = "10px 20px";
                     retryButton.style.border = "none";
                     retryButton.style.borderRadius = "10px";
                     retryButton.style.backgroundColor = "rgba(76, 161, 175, 0.6)";
                     retryButton.style.color = "white";
                     retryButton.style.cursor = "pointer";
                     retryButton.style.fontSize = "16px";
                     retryButton.onclick = loadModel;
 
                     uploadButton.parentElement.appendChild(retryButton);
                 }
             }
         }
 
         async function loadVoices() {
             voices = window.speechSynthesis.getVoices();
             if (voices.length === 0) {
                 window.speechSynthesis.onvoiceschanged = () => {
                     voices = window.speechSynthesis.getVoices();
                     populateVoiceList();
                 };
             } else {
                 populateVoiceList();
             }
         }
 
         function populateVoiceList() {
             const voiceSelect = document.getElementById('voice-select');
             if (!voiceSelect) return;
 
             voiceSelect.innerHTML = '<option value="">Select Voice</option>';
             voices.forEach((voice, index) => {
                 const option = document.createElement('option');
                 option.value = index;
                 option.textContent = `${voice.name} (${voice.lang})`;
                 voiceSelect.appendChild(option);
             });
 
             const storedVoiceIndex = localStorage.getItem('selectedVoice');
             if (storedVoiceIndex !== null && voices[storedVoiceIndex]) {
                 voiceSelect.value = storedVoiceIndex;
             }
 
             voiceSelect.addEventListener('change', changeVoice);
         }
 
         function toggleTTSControls() {
             const ttsControls = document.getElementById('tts-controls');
             if (!ttsControls) return;
             ttsControls.style.display = ttsControls.style.display === 'none' || ttsControls.style.display === '' ? 'flex' : 'none';
         }
 
         function toggleVoiceOutput() {
             voiceOutputEnabled = !voiceOutputEnabled;
             localStorage.setItem('voiceOutputEnabled', voiceOutputEnabled);
             
             const voiceOutputButton = document.querySelector('#more-options-dropdown button[onclick="toggleVoiceOutput()"]');
             if (voiceOutputButton) {
                 voiceOutputButton.textContent = voiceOutputEnabled ? '🔊 Voice Output: On' : '🔊 Voice Output: Off';
             }
             
             const ttsControls = document.getElementById('tts-controls');
             if (ttsControls) {
                 ttsControls.style.display = voiceOutputEnabled ? 'flex' : 'none';
             }
         }
 
         function changeVoice() {
             const voiceSelect = document.getElementById('voice-select');
             const selectedIndex = voiceSelect.value;
             if (selectedIndex === "") return;
 
             localStorage.setItem('selectedVoice', selectedIndex);
         }
 
         function playSpeech() {
             if (!voiceOutputEnabled) return;
             if (window.speechSynthesis.paused) {
                 window.speechSynthesis.resume();
             } else {
                 const chatbox = document.getElementById("chatbox");
                 const botMessages = chatbox.querySelectorAll('.bot-message');
                 const lastBotMessage = botMessages.length > 0 ? botMessages[botMessages.length - 1] : null;
                 if (lastBotMessage) {
                     const speechText = lastBotMessage.innerText.replace(/[^a-zA-Z0-9\s.,?!]/g, '');
                     speakText(speechText);
                 }
             }
         }
 
         function pauseSpeech() {
             if (!voiceOutputEnabled) return;
             window.speechSynthesis.pause();
         }
 
         function stopSpeech() {
             if (!voiceOutputEnabled) return;
             window.speechSynthesis.cancel();
         }
 
         function adjustSpeechRate(rate) {
             localStorage.setItem('speechRate', rate);
             if (window.speechSynthesis.speaking) {
                 window.speechSynthesis.cancel();
             }
         }
 
         function speakText(text) {
             if (!voiceOutputEnabled) return;
             if (!window.speechSynthesis) {
                 console.warn('Speech Synthesis not supported in this browser.');
                 return;
             }
 
             window.speechSynthesis.cancel();
 
             const utterance = new SpeechSynthesisUtterance(text);
 
             const voiceSelect = document.getElementById('voice-select');
             if (voiceSelect) {
                 const selectedIndex = voiceSelect.value;
                 if (selectedIndex !== "") {
                     utterance.voice = voices[selectedIndex];
                 } else if (voices.length > 0) {
                     utterance.voice = voices.find(voice => voice.lang === 'en-US') || voices[0];
                 }
             }
 
             const storedRate = parseFloat(localStorage.getItem('speechRate')) || 1;
             utterance.rate = storedRate;
 
             utterance.pitch = 1;
             utterance.volume = 1;
 
             window.speechSynthesis.speak(utterance);
         }
 
         async function typeText(messageDiv, text) {
             const typingSpeed = 1; 
             messageDiv.innerHTML = '';
 
             for (let i = 0; i < text.length; i++) {
                 messageDiv.innerHTML += text.charAt(i);
                 messageDiv.scrollTop = messageDiv.scrollHeight;
                 await new Promise(resolve => setTimeout(resolve, typingSpeed));
             }
 
             const rewriteButton = document.createElement("button");
             rewriteButton.textContent = "🔄 Rewrite";
             rewriteButton.className = "rewrite-button";
             rewriteButton.onclick = () => rewriteMessage(messageDiv, text);
             messageDiv.appendChild(rewriteButton);
 
             const speechText = text.replace(/<[^>]+>/g, '');
             speakText(speechText);
         }
 
         function displayMessage(text, className) {
             console.log("Displaying message:", text, "Class:", className);
             const chatbox = document.getElementById("chatbox");
             const messageDiv = document.createElement("div");
             messageDiv.className = `message ${className}`;
 
             if (text.startsWith("```") && text.endsWith("```")) {
                 const pre = document.createElement("pre");
                 const code = document.createElement("code");
                 
                 const languageMatch = text.match(/```(\w+)/);
                 const language = languageMatch ? languageMatch[1] : '';
                 const codeContent = text.replace(/```(\w+)?\n?/, '').replace(/```$/, '');
                 
                 code.className = `language-${language}`;
                 code.textContent = codeContent;
                 pre.appendChild(code);
                 messageDiv.appendChild(pre);
                 Prism.highlightElement(code);
             } 
             else if (text.includes('<div class="aggregated-answer">')) {
                 messageDiv.innerHTML = text;
             } 
             else if (text.startsWith("<img")) {
                 messageDiv.classList.add("image-message");
                 messageDiv.innerHTML = text;
             } 
             else if (text.includes('<ul>') || text.includes('<ol>')) {
                 if (!document.body.classList.contains('simple-mode')) {
                     const keyTerms = ['dyslexia', 'photosynthesis', 'assignment', 'multiplication', 'division'];
                     text = highlightTerms(text, keyTerms);
                 }
                 messageDiv.innerHTML = text;
             } 
             else {
                 if (!document.body.classList.contains('simple-mode')) {
                     const keyTerms = ['dyslexia', 'photosynthesis', 'assignment', 'multiplication', 'division'];
                     text = highlightTerms(text, keyTerms);
                 }
 
                 if (className === "bot-message") {
                     typeText(messageDiv, text);
                 } else {
                     messageDiv.innerHTML = text;
                     addToHistory(text);
                 }
             }
             
             chatbox.appendChild(messageDiv);
             chatbox.scrollTop = chatbox.scrollHeight;
 
             let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
             chatHistory.push({ text: text, class: className, timestamp: new Date() });
             localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
         }
 
         function highlightTerms(text, terms) {
             terms.forEach(term => {
                 const regex = new RegExp(`\\b(${term})\\b`, 'gi');
                 text = text.replace(regex, '<span class="highlight">$1</span>');
             });
             return text;
         }
 
         function rewriteMessage(messageDiv, originalText) {
             const existingRewritten = messageDiv.querySelector('.rewritten-message');
             if (existingRewritten) {
                 existingRewritten.remove();
             }
 
             const simplifiedText = simplifyText(originalText);
 
             const rewrittenDiv = document.createElement("div");
             rewrittenDiv.className = "message bot-message rewritten-message";
             rewrittenDiv.innerHTML = `📝 **Rewritten:** ${simplifiedText}`;
             
             messageDiv.appendChild(rewrittenDiv);
             const chatbox = document.getElementById("chatbox");
             chatbox.scrollTop = chatbox.scrollHeight;
         }
 
         function simplifyText(text) {
             const simplificationDictionary = {
                 "utilize": "use",
                 "commence": "start",
                 "endeavor": "try",
                 "facilitate": "help",
                 "approximately": "about",
                 "consequently": "so",
                 "ameliorate": "improve",
                 "perceive": "see",
                 "ascertain": "find out",
                 "disseminate": "spread",
                 "terminate": "end",
                 "demonstrate": "show",
                 "sufficient": "enough",
                 "significant": "important",
                 "predominantly": "mainly",
                 "implement": "carry out",
                 "subsequent": "next",
                 "comprehensive": "complete",
                 "procure": "get",
                 "acquire": "get",
                 "conversely": "on the other hand",
                 "persuade": "convince",
                 "difficult": "hard",
                 "assistance": "help",
                 "expedite": "speed up",
                 "collaborate": "work together",
                 "remuneration": "payment",
                 "inquire": "ask",
                 "depart": "leave",
                 "elucidate": "explain",
                 "necessitate": "require",
                 "create": "make",
                 "generate": "make",
                 "innovate": "create",
             };
 
             const words = text.split(/(\b)/);
             const simplifiedWords = words.map(word => {
                 const lowerCaseWord = word.toLowerCase();
                 if (simplificationDictionary[lowerCaseWord]) {
                     if (word[0] === word[0].toUpperCase()) {
                         return simplificationDictionary[lowerCaseWord].charAt(0).toUpperCase() + simplificationDictionary[lowerCaseWord].slice(1);
                     }
                     return simplificationDictionary[lowerCaseWord];
                 }
                 return word;
             });
             return simplifiedWords.join('');
         }
 
         async function sendMessage() {
             if (isGenerating) {
                 displayMessage("⏳ Please wait while I generate a response...", "bot-message");
                 return;
             }
 
             isGenerating = true;
 
             console.log("sendMessage function called");
             const messageInput = document.getElementById("message-input");
             const userMessage = messageInput.value.trim();
             console.log("User Message:", userMessage);
 
             if (!userMessage) {
                 console.log("No message to send.");
                 isGenerating = false;
                 return;
             }
 
             displayMessage(userMessage, "user-message");
             messageInput.value = "";
             messageInput.style.height = '50px';
 
             const chatbox = document.getElementById("chatbox");
             const typingIndicator = document.createElement("div");
             typingIndicator.className = "message bot-message typing-indicator";
             typingIndicator.innerHTML = `ByteBuddy is typing... <span class="loader"></span>`;
             chatbox.appendChild(typingIndicator);
             chatbox.scrollTop = chatbox.scrollHeight;
 
             try {
                 const botResponse = await chatbot.respond(userMessage);
                 console.log("Bot Response:", botResponse);
 
                 chatbox.removeChild(typingIndicator);
                 displayMessage(botResponse, "bot-message");
             } catch (error) {
                 console.error("Error in sendMessage:", error);
                 displayMessage("❌ An error occurred while processing your message.", "bot-message");
                 chatbox.removeChild(typingIndicator);
             } finally {
                 isGenerating = false;
             }
         }

let history = [];

        function addToHistory(userMessage) {
            const timestamp = new Date(); 
            history.push({ message: userMessage, timestamp: timestamp });

            updateHistoryPane();
        }

        function updateHistoryPane() {
            const historyPane = document.getElementById('history-content');
            historyPane.innerHTML = "";

            const categorizedHistory = categorizeHistory(history);

     
            for (const [category, messages] of Object.entries(categorizedHistory)) {
                if (messages.length > 0) {

                    const categoryHeader = document.createElement('h4');
                    categoryHeader.textContent = category;
                    historyPane.appendChild(categoryHeader);

                    messages.forEach((entry) => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'history-message';
                        messageDiv.textContent = `${entry.message} (${formatTime(entry.timestamp)})`;
                        historyPane.appendChild(messageDiv);
                    });
                }
            }
        }

        function categorizeHistory(history) {
            const now = new Date();
            const categorized = {
                Today: [],
                Yesterday: [],
                "Previous 7 Days": [],
                "1 Month Ago": [],
            };

            history.forEach((entry) => {
                const entryDate = new Date(entry.timestamp);
                const differenceInDays = Math.floor((now - entryDate) / (1000 * 60 * 60 * 24));

                if (differenceInDays === 0) {
                    categorized.Today.push(entry);
                } else if (differenceInDays === 1) {
                    categorized.Yesterday.push(entry);
                } else if (differenceInDays <= 7) {
                    categorized["Previous 7 Days"].push(entry);
                } else if (differenceInDays <= 30) {
                    categorized["1 Month Ago"].push(entry);
                }
            });

            return categorized;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }


        function sendMessage() {
            const userInput = document.getElementById('message-input').value.trim();
            if (!userInput) return;

            addToHistory(userInput);
            document.getElementById('message-input').value = "";
        }

 
         function addToHistory(message) {
             const historyContent = document.getElementById("history-content");
             const historyMessageDiv = document.createElement("div");
             historyMessageDiv.className = "history-message";
             historyMessageDiv.innerHTML = message;
             historyContent.appendChild(historyMessageDiv);
             historyContent.scrollTop = historyContent.scrollHeight;
         }
 
         function loadHistory() {
             const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
             chatHistory.forEach(entry => {
                 if (entry.class === "user-message") {
                     addToHistory(entry.text);
                 }
             });
         }
 
         async function startChat() {
             const homePage = document.getElementById('home-page');
             const mainContainer = document.getElementById('main-container');
             const homeMessageInput = document.getElementById('home-message-input');
             const userName = localStorage.getItem('userName') || 'User';
 
             const userMessage = homeMessageInput.value.trim();
             if (!userMessage) return;
 
             homePage.classList.add('hidden');
 
             mainContainer.style.display = 'flex';
 
             displayMessage(userMessage, "user-message");
 
             homeMessageInput.value = "";
             homeMessageInput.style.height = '50px';
 
             displayMessage(`Hello, ${userName}! 😊 How can I assist you today?`, "bot-message");
         }


async function fetchCountryInfo(country) {
    const apiUrl = `https://restcountries.com/v3.1/name/${encodeURIComponent(country)}`;

    try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (data && data[0]) {
            const { name, population, region, capital, languages, area } = data[0];
            const languageNames = Object.values(languages).join(", ");

            const description = `
                🌍 **Country Information: ${name.common}**
                ${name.common} is a country located in the ${region} region. Its capital city is ${capital[0] || "N/A"}, 
                and it spans an area of approximately ${area.toLocaleString()} square kilometers. 
                The country has a population of about ${population.toLocaleString()} people, 
                with the primary languages being ${languageNames}.
                ${name.common} is known for its unique cultural heritage, diverse landscapes, 
                and significant role in regional and global affairs.
            `.trim();

            return description;
        } else {
            return "❌ No country information found.";
        }
    } catch (error) {
        console.error("Error fetching country info:", error);
        return "⚠️ Error fetching country information.";
    }
}

 
         async function loadModel() {
             displayMessage("🔄 Loading image recognition model...", "bot-message");
             const uploadButton = document.getElementById('upload-image-button');
 
             uploadButton.classList.add('disabled');
             uploadButton.innerHTML = `📷 Upload Image <span class="loader"></span>`;
 
             try {
                 model = await mobilenet.load();
                 modelLoaded = true;
                 displayMessage("✅ Image recognition model loaded and ready to use!", "bot-message");
                 uploadButton.classList.remove('disabled');
                 uploadButton.innerHTML = "📷 Upload Image";
             } catch (error) {
                 displayMessage("❌ Failed to load the image recognition model.", "bot-message");
                 console.error(error);
 
                 const existingRetryButton = uploadButton.parentElement.querySelector('.retry-button');
                 if (!existingRetryButton) {
                     const retryButton = document.createElement('button');
                     retryButton.textContent = "🔄 Retry Loading Model";
                     retryButton.className = "retry-button";
                     retryButton.style.marginTop = "10px";
                     retryButton.style.padding = "10px 20px";
                     retryButton.style.border = "none";
                     retryButton.style.borderRadius = "10px";
                     retryButton.style.backgroundColor = "rgba(76, 161, 175, 0.6)";
                     retryButton.style.color = "white";
                     retryButton.style.cursor = "pointer";
                     retryButton.style.fontSize = "16px";
                     retryButton.onclick = loadModel;
 
                     uploadButton.parentElement.appendChild(retryButton);
                 }
             }
         }
 
         async function loadVoices() {
             voices = window.speechSynthesis.getVoices();
             if (voices.length === 0) {
                 window.speechSynthesis.onvoiceschanged = () => {
                     voices = window.speechSynthesis.getVoices();
                     populateVoiceList();
                 };
             } else {
                 populateVoiceList();
             }
         }
 
         function populateVoiceList() {
             const voiceSelect = document.getElementById('voice-select');
             if (!voiceSelect) return;
 
             voiceSelect.innerHTML = '<option value="">Select Voice</option>';
             voices.forEach((voice, index) => {
                 const option = document.createElement('option');
                 option.value = index;
                 option.textContent = `${voice.name} (${voice.lang})`;
                 voiceSelect.appendChild(option);
             });
 
             const storedVoiceIndex = localStorage.getItem('selectedVoice');
             if (storedVoiceIndex !== null && voices[storedVoiceIndex]) {
                 voiceSelect.value = storedVoiceIndex;
             }
 
             voiceSelect.addEventListener('change', changeVoice);
         }
 
         function toggleTTSControls() {
             const ttsControls = document.getElementById('tts-controls');
             if (!ttsControls) return;
             ttsControls.style.display = ttsControls.style.display === 'none' || ttsControls.style.display === '' ? 'flex' : 'none';
         }
 
         function toggleVoiceOutput() {
             voiceOutputEnabled = !voiceOutputEnabled;
             localStorage.setItem('voiceOutputEnabled', voiceOutputEnabled);
             
             const voiceOutputButton = document.querySelector('#more-options-dropdown button[onclick="toggleVoiceOutput()"]');
             if (voiceOutputButton) {
                 voiceOutputButton.textContent = voiceOutputEnabled ? '🔊 Voice Output: On' : '🔊 Voice Output: Off';
             }
             
             const ttsControls = document.getElementById('tts-controls');
             if (ttsControls) {
                 ttsControls.style.display = voiceOutputEnabled ? 'flex' : 'none';
             }
         }
 
         function changeVoice() {
             const voiceSelect = document.getElementById('voice-select');
             const selectedIndex = voiceSelect.value;
             if (selectedIndex === "") return;
 
             localStorage.setItem('selectedVoice', selectedIndex);
         }
 
         function playSpeech() {
             if (!voiceOutputEnabled) return;
             if (window.speechSynthesis.paused) {
                 window.speechSynthesis.resume();
             } else {
                 const chatbox = document.getElementById("chatbox");
                 const botMessages = chatbox.querySelectorAll('.bot-message');
                 const lastBotMessage = botMessages.length > 0 ? botMessages[botMessages.length - 1] : null;
                 if (lastBotMessage) {
                     const speechText = lastBotMessage.innerText.replace(/[^a-zA-Z0-9\s.,?!]/g, '');
                     speakText(speechText);
                 }
             }
         }
 
         function pauseSpeech() {
             if (!voiceOutputEnabled) return;
             window.speechSynthesis.pause();
         }
 
         function stopSpeech() {
             if (!voiceOutputEnabled) return;
             window.speechSynthesis.cancel();
         }
 
         function adjustSpeechRate(rate) {
             localStorage.setItem('speechRate', rate);
             if (window.speechSynthesis.speaking) {
                 window.speechSynthesis.cancel();
             }
         }
 
         function speakText(text) {
             if (!voiceOutputEnabled) return;
             if (!window.speechSynthesis) {
                 console.warn('Speech Synthesis not supported in this browser.');
                 return;
             }
 
             window.speechSynthesis.cancel();
 
             const utterance = new SpeechSynthesisUtterance(text);
 
             const voiceSelect = document.getElementById('voice-select');
             if (voiceSelect) {
                 const selectedIndex = voiceSelect.value;
                 if (selectedIndex !== "") {
                     utterance.voice = voices[selectedIndex];
                 } else if (voices.length > 0) {
                     utterance.voice = voices.find(voice => voice.lang === 'en-US') || voices[0];
                 }
             }
 
             const storedRate = parseFloat(localStorage.getItem('speechRate')) || 1;
             utterance.rate = storedRate;
 
             utterance.pitch = 1;
             utterance.volume = 1;
 
             window.speechSynthesis.speak(utterance);
         }
 
         async function typeText(messageDiv, text) {
             const typingSpeed = 1; 
             messageDiv.innerHTML = '';
 
             for (let i = 0; i < text.length; i++) {
                 messageDiv.innerHTML += text.charAt(i);
                 messageDiv.scrollTop = messageDiv.scrollHeight;
                 await new Promise(resolve => setTimeout(resolve, typingSpeed));
             }
 
             const rewriteButton = document.createElement("button");
             rewriteButton.textContent = "🔄 Rewrite";
             rewriteButton.className = "rewrite-button";
             rewriteButton.onclick = () => rewriteMessage(messageDiv, text);
             messageDiv.appendChild(rewriteButton);
 
             const speechText = text.replace(/<[^>]+>/g, '');
             speakText(speechText);
         }
 
         function rewriteMessage(messageDiv, originalText) {
             const existingRewritten = messageDiv.querySelector('.rewritten-message');
             if (existingRewritten) {
                 existingRewritten.remove();
             }
 
             const simplifiedText = simplifyText(originalText);
 
             const rewrittenDiv = document.createElement("div");
             rewrittenDiv.className = "message bot-message rewritten-message";
             rewrittenDiv.innerHTML = `📝 **Rewritten:** ${simplifiedText}`;
             
             messageDiv.appendChild(rewrittenDiv);
             const chatbox = document.getElementById("chatbox");
             chatbox.scrollTop = chatbox.scrollHeight;
         }
 
         function simplifyText(text) {
             const simplificationDictionary = {
                 "utilize": "use",
                 "commence": "start",
                 "endeavor": "try",
                 "facilitate": "help",
                 "approximately": "about",
                 "consequently": "so",
                 "ameliorate": "improve",
                 "perceive": "see",
                 "ascertain": "find out",
                 "disseminate": "spread",
                 "terminate": "end",
                 "demonstrate": "show",
                 "sufficient": "enough",
                 "significant": "important",
                 "predominantly": "mainly",
                 "implement": "carry out",
                 "subsequent": "next",
                 "comprehensive": "complete",
                 "procure": "get",
                 "acquire": "get",
                 "conversely": "on the other hand",
                 "persuade": "convince",
                 "difficult": "hard",
                 "assistance": "help",
                 "expedite": "speed up",
                 "collaborate": "work together",
                 "remuneration": "payment",
                 "inquire": "ask",
                 "depart": "leave",
                 "elucidate": "explain",
                 "necessitate": "require",
                 "create": "make",
                 "generate": "make",
                 "innovate": "create",
             };
 
             const words = text.split(/(\b)/);
             const simplifiedWords = words.map(word => {
                 const lowerCaseWord = word.toLowerCase();
                 if (simplificationDictionary[lowerCaseWord]) {
                     if (word[0] === word[0].toUpperCase()) {
                         return simplificationDictionary[lowerCaseWord].charAt(0).toUpperCase() + simplificationDictionary[lowerCaseWord].slice(1);
                     }
                     return simplificationDictionary[lowerCaseWord];
                 }
                 return word;
             });
             return simplifiedWords.join('');
         }
     </script>
 
     <script>
         async function sendMessage() {
             if (isGenerating) {
                 displayMessage("⏳ Please wait while I generate a response...", "bot-message");
                 return;
             }
 
             isGenerating = true;
 
             console.log("sendMessage function called");
             const messageInput = document.getElementById("message-input");
             const userMessage = messageInput.value.trim();
             console.log("User Message:", userMessage);
 
             if (!userMessage) {
                 console.log("No message to send.");
                 isGenerating = false;
                 return;
             }
 
             displayMessage(userMessage, "user-message");
             messageInput.value = "";
             messageInput.style.height = '50px';
 
             const chatbox = document.getElementById("chatbox");
             const typingIndicator = document.createElement("div");
             typingIndicator.className = "message bot-message typing-indicator";
             typingIndicator.innerHTML = `ByteBuddy is typing... <span class="loader"></span>`;
             chatbox.appendChild(typingIndicator);
             chatbox.scrollTop = chatbox.scrollHeight;
 
             try {
                 const botResponse = await chatbot.respond(userMessage);
                 console.log("Bot Response:", botResponse);
 
                 chatbox.removeChild(typingIndicator);
                 displayMessage(botResponse, "bot-message");
             } catch (error) {
                 console.error("Error in sendMessage:", error);
                 displayMessage("❌ An error occurred while processing your message.", "bot-message");
                 chatbox.removeChild(typingIndicator);
             } finally {
                 isGenerating = false;
             }
         }
 
         function addToHistory(message) {
             const historyContent = document.getElementById("history-content");
             const historyMessageDiv = document.createElement("div");
             historyMessageDiv.className = "history-message";
             historyMessageDiv.innerHTML = message;
             historyContent.appendChild(historyMessageDiv);
             historyContent.scrollTop = historyContent.scrollHeight;
         }
 
         function loadHistory() {
             const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
             chatHistory.forEach(entry => {
                 if (entry.class === "user-message") {
                     addToHistory(entry.text);
                 }
             });
         }
 
         async function startChat() {
             const homePage = document.getElementById('home-page');
             const mainContainer = document.getElementById('main-container');
             const homeMessageInput = document.getElementById('home-message-input');
             const userName = localStorage.getItem('userName') || 'User';
 
             const userMessage = homeMessageInput.value.trim();
             if (!userMessage) return;
 
             homePage.classList.add('hidden');
 
             mainContainer.style.display = 'flex';
 
             displayMessage(userMessage, "user-message");
 
             homeMessageInput.value = "";
             homeMessageInput.style.height = '50px';
 
             displayMessage(`Hello, ${userName}! 😊 How can I assist you today?`, "bot-message");
         }
     </script>
 
 </body>
 </html>
